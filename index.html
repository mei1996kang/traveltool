<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 Osaka Trip</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg-color: #fdfdfd; --text-main: #333333; --jp-blue: #1a2a6c; --jp-accent: #c04848; }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: var(--bg-color); color: var(--text-main); line-height: 1.6; }
        .serif { font-family: 'Playfair Display', serif; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }

        /* Ë°åÁ®ãÊôÇÈñìËª∏ */
        .timeline-item { position: relative; display: flex; padding-bottom: 2.5rem; }
        .time-side { width: 70px; flex-shrink: 0; text-align: right; padding-right: 20px; font-size: 1.25rem; font-weight: 700; color: #111; position: relative; }
        .time-side::after { content: ''; position: absolute; right: -1px; top: 12px; width: 9px; height: 9px; background: white; border: 1px solid #ddd; border-radius: 50%; z-index: 10; }
        .timeline-line { position: absolute; left: 69.5px; top: 12px; bottom: 0; width: 1px; background: #eee; }
        .content-side { flex: 1; padding-left: 20px; padding-top: 2px; }

        /* Ë©≥ÊÉÖÂΩàÁ™ó */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(8px); }
        .modal-content { 
            background: white; margin: 10vh auto; width: 90%; max-width: 450px; 
            border-radius: 24px; position: relative; max-height: 80vh; overflow-y: auto;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2); animation: fadeInUp 0.4s ease;
        }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* Â∞éË¶ΩÂàó */
        .nav-active { color: var(--jp-blue) !important; font-weight: 700; }
        .day-btn.active { color: #111; font-weight: 700; border-bottom: 2px solid #111; }

        /* ‰ª£Ë≥ºÊ®£Âºè */
        .purchased-item { opacity: 0.6; background-color: #f9f9f9 !important; }
        .purchased-item .item-title { text-decoration: line-through; }
        .filter-btn.active { background-color: var(--jp-blue); color: white; }
    </style>
</head>
<body class="pb-24 text-sm">

    <!-- Header -->
    <header class="p-6 text-center">
        <div class="text-[9px] text-gray-400 tracking-[0.4em] mb-1 font-light uppercase">Osaka Trip</div>
        <h1 class="text-xl font-bold tracking-widest serif">Â§ßÈò™ ‚óè ‰∫¨ÈÉΩ ‚óè ÂÖµÂ∫´</h1>
    </header>

    <!-- Ë©≥ÊÉÖ Lightbox -->
    <div id="infoModal" class="modal" onclick="closeModal()">
        <div class="modal-content p-8" onclick="event.stopPropagation()">
            <button class="absolute top-6 right-6 text-gray-400" onclick="closeModal()"><i class="fas fa-times text-xl"></i></button>
            <div id="modal-body" class="space-y-6"></div>
        </div>
    </div>

    <!-- 1. Ë°åÁ®ãÈ†ÅÁ±§ -->
    <div id="itinerary" class="tab-content active px-6">
        <div class="flex justify-between mb-8 overflow-x-auto hide-scrollbar space-x-6 px-2">
            <button onclick="showDay(1)" class="day-btn pb-1 text-gray-300 min-w-fit"><span class="text-[9px] block">MON</span><span class="text-lg serif">2/2</span></button>
            <button onclick="showDay(2)" class="day-btn pb-1 text-gray-300 min-w-fit"><span class="text-[9px] block">TUE</span><span class="text-lg serif">2/3</span></button>
            <button onclick="showDay(3)" class="day-btn pb-1 text-gray-300 min-w-fit"><span class="text-[9px] block">WED</span><span class="text-lg serif">2/4</span></button>
            <button onclick="showDay(4)" class="day-btn pb-1 text-gray-300 min-w-fit"><span class="text-[9px] block">THU</span><span class="text-lg serif">2/5</span></button>
            <button onclick="showDay(5)" class="day-btn pb-1 text-gray-300 min-w-fit"><span class="text-[9px] block">FRI</span><span class="text-lg serif">2/6</span></button>
        </div>
        <div id="weather-section" class="mb-10 text-center border-y border-gray-50 py-4">
            <h2 id="weather-city" class="text-xs font-medium tracking-widest uppercase mb-4 text-gray-400">Weather</h2>
            <div id="hourly-weather" class="flex space-x-4 overflow-x-auto hide-scrollbar"></div>
        </div>
        <div id="day-content" class="relative"></div>
    </div>

    <!-- 2. ‰ª£Ë≥ºÊ∏ÖÂñÆ (ÂÖ®Êñ∞ÂçáÁ¥ö) -->
    <div id="shopping" class="tab-content p-6">
        <div class="bg-white p-6 rounded-3xl border border-gray-100 mb-6">
            <h3 class="text-[10px] font-bold mb-4 tracking-widest text-gray-300 uppercase">New Wish Item</h3>
            <div class="space-y-3">
                <input type="text" id="shop-name" placeholder="ÂïÜÂìÅÂêçÁ®±" class="w-full border-b border-gray-100 py-2 outline-none">
                <div class="grid grid-cols-2 gap-4">
                    <input type="text" id="shop-spec" placeholder="Ë¶èÊ†º (Â¶Ç: 200g, ËóçËâ≤)" class="w-full border-b border-gray-100 py-2 outline-none">
                    <input type="number" id="shop-qty" placeholder="Êï∏Èáè" class="w-full border-b border-gray-100 py-2 outline-none">
                </div>
                <input type="text" id="shop-loc" placeholder="‰ª£Ë≥ºÂ†¥ÊâÄ (Â¶Ç: Â§ßÂúãËó•Â¶ù)" class="w-full border-b border-gray-100 py-2 outline-none">
                <!-- Âú® shop-loc (‰ª£Ë≥ºÂ†¥ÊâÄ) Ê¨Ñ‰Ωç‰πãÂæåÂä†ÂÖ• -->
<input type="text" id="shop-purchaser" placeholder="Ë≥ºË≤∑ËÄÖ (Â¶Ç: Êàë, ËÄÅÂ©Ü, ÁéãÂ∞èÊòé)" class="w-full border-b border-gray-100 py-2 outline-none mb-2">
				<label class="block border border-dashed border-gray-200 py-4 text-center rounded-2xl text-gray-400 text-[10px] cursor-pointer">
                    <i class="fas fa-camera mr-2"></i>‰∏äÂÇ≥ÂèÉËÄÉÂúñÁâá
                    <input type="file" accept="image/*" class="hidden" onchange="processImage(this, 'shop')">
                </label>
                <button onclick="addShoppingItem()" class="w-full bg-black text-white py-4 rounded-full text-[10px] tracking-widest font-bold">ADD TO LIST</button>
            </div>
        </div>

        <!-- ÁØ©ÈÅ∏Ê¨Ñ‰Ωç -->
        <div class="mb-4">
            <p class="text-[9px] text-gray-400 uppercase tracking-widest mb-2">Filter by Location</p>
            <div id="shop-filter-bar" class="flex space-x-2 overflow-x-auto hide-scrollbar">
                <!-- Áî± JS ÁîüÊàê -->
            </div>
        </div>

        <div id="shopping-list" class="space-y-4"></div>
    </div>

    <!-- 3. Ë®òÂ∏≥Â∑•ÂÖ∑ -->
    <div id="ledger" class="tab-content p-6">
        <div class="bg-white p-6 rounded-3xl border border-gray-100 mb-6">
            <h3 class="text-[10px] font-bold mb-4 tracking-widest text-gray-300 uppercase">Expense</h3>
            <div class="grid grid-cols-2 gap-4">
                <input type="text" id="exp-name" placeholder="È†ÖÁõÆ" class="border-b border-gray-100 py-2 outline-none">
                <input type="number" id="exp-amount" placeholder="ÈáëÈ°ç ¬•" class="border-b border-gray-100 py-2 outline-none">
                <select id="exp-method" class="border-b border-gray-100 py-2 bg-transparent outline-none">
                    <option>ÁèæÈáë</option><option>Âà∑Âç°</option><option>Suica</option>
                </select>
                <input type="date" id="exp-date" class="border-b border-gray-100 py-2 outline-none bg-transparent">
            </div>
            <button onclick="addExpense()" class="w-full bg-black text-white py-4 rounded-full text-[10px] tracking-widest font-bold mt-6">SAVE EXPENSE</button>
        </div>
        <div id="expense-list" class="space-y-1"></div>
        <div id="total-amount" class="mt-8 text-right font-light text-xl">Total <span class="serif text-4xl font-bold ml-2">¬•0</span></div>
    </div>

    <!-- 4. Êñá‰ª∂/Á•®Âà∏ -->
    <div id="tickets" class="tab-content p-6">
        <div class="bg-white p-6 rounded-3xl border border-gray-100 mb-6">
            <h3 class="text-[10px] font-bold mb-4 tracking-widest text-gray-300 uppercase">Documents</h3>
            <input type="text" id="doc-name" placeholder="Êñá‰ª∂Ê®ôÈ°å" class="w-full border-b border-gray-100 py-2 outline-none mb-4">
            <label class="block border border-dashed border-gray-200 py-8 text-center rounded-2xl text-gray-400 text-[10px] cursor-pointer mb-6">
                ‰∏äÂÇ≥Êà™Âúñ <input type="file" accept="image/*" class="hidden" onchange="processImage(this, 'doc')">
            </label>
            <button onclick="addDoc()" class="w-full bg-black text-white py-4 rounded-full text-[10px] tracking-widest font-bold">UPLOAD</button>
        </div>
        <div id="doc-list" class="space-y-3"></div>
    </div>

    <!-- Navbar -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-xl border-t border-gray-50 flex justify-around p-4 safe-area-bottom z-50">
        <button onclick="switchTab('itinerary')" class="nav-btn flex flex-col items-center nav-active text-gray-400"><i class="fas fa-stream text-lg"></i><span class="text-[9px] mt-1">PLAN</span></button>
        <button onclick="switchTab('shopping')" class="nav-btn flex flex-col items-center text-gray-400"><i class="fas fa-shopping-cart text-lg"></i><span class="text-[9px] mt-1">SHOP</span></button>
        <button onclick="switchTab('ledger')" class="nav-btn flex flex-col items-center text-gray-400"><i class="fas fa-wallet text-lg"></i><span class="text-[9px] mt-1">CASH</span></button>
        <button onclick="switchTab('tickets')" class="nav-btn flex flex-col items-center text-gray-400"><i class="fas fa-folder text-lg"></i><span class="text-[9px] mt-1">DOCS</span></button>
    </nav>

    <script>
        // --- Ê†∏ÂøÉË≥áÊñô ---
        const travelData = {
            1: { city: "Osaka", items: [
                { t: "06:00", d: "‰ΩèÂÆ∂ ‚Üí Ê©üÊç∑Âè∞ÂåóËªäÁ´ô", type: "TRANS", m: "Ë®àÁ®ãËªä", r: "Âá∫ÁôºÔºÅ" },
                { t: "09:20", d: "ÊòüÂÆáËà™Á©∫ JX822", type: "FLIGHT", m: "Ê°ÉÂúíÊ©üÂ†¥ (TPE)", detail: { address: "Á¨¨‰∏ÄËà™Âªà", booking: "JX-822", about: "È†êË®à 12:50 ÊäµÈÅîÈóúË•ø KIX" }},
                { t: "13:56", d: "üõçÔ∏è Ëá®Á©∫Âüé Outlet", type: "SHOP", m: "Rinku Town", r: "Ëó•Â¶ù„ÄÅÊúçÈ£æÈ¶ñÁ´ô„ÄÇ", detail: { address: "Â§ßÈò™Â∫úÊ≥â‰ΩêÈáéÂ∏ÇRinkuÂæÄ‰æÜÂçó3-28", about: "ÂøÖË≤∑ÔºöË•øÊùæÂ±ã„ÄÅOnitsuka Tiger„ÄÇ" }},
                { t: "19:25", d: "Èõ£Ê≥¢Ê†ºÂà©Ëå≤È£ØÂ∫óÂÖ•‰Ωè", type: "HOTEL", m: "GRIDS PREMIUM", detail: { address: "Â§ßÈò™Â∫úÂ§ßÈò™Â∏ÇÊµ™ÈÄüÂçÄÈõ£Ê≥¢‰∏≠1-7-7", booking: "GRIDS-9900" }}
            ]},
            2: { city: "Kyoto", items: [
                { t: "07:15", d: "KKDAY Â∑¥Â£´ÈõÜÂêà", type: "TRANS", m: "Êó•Êú¨Ê©ã", detail: { address: "ËüπÈÅìÊ®ÇÈÅìÈ†ìÂ†ÄÊù±Â∫ó", about: "Ê∫ñÊôÇÁôºËªäÔºåÈÄæÊôÇ‰∏çÂÄô„ÄÇ" }},
                { t: "11:00", d: "Â§©Ê©ãÁ´ã ÂÇòÊùæÂÖ¨Âúí", type: "SIGHT", m: "Amanohashidate", detail: { about: "Êó•Êú¨‰∏âÊôØÔºåÊê≠‰πòÁ∫úËªäÁúãÂÄíÈ†≠Ê†Ω„ÄÇ" }},
                { t: "19:00", d: "Ê¢ÖÁî∞Èæç‰ªïÊüèÈ£ØÂ∫óÂÖ•‰Ωè", type: "HOTEL", m: "Hotel Hankyu", detail: { address: "Â§ßÈò™Â∫úÂ§ßÈò™Â∏ÇÂåóÂçÄÂ§ßÊ∑±Áî∫1-1", booking: "RESPIRE-BK" }}
            ]},
            3: { city: "Kyoto", items: [
                { t: "14:40", d: "Ë≤¥ËàπÁ•ûÁ§æ", type: "SIGHT", m: "Kifune", detail: { address: "‰∫¨ÈÉΩÂ∏ÇÂ∑¶‰∫¨ÂçÄÈûçÈ¶¨Ë≤¥ËàπÁî∫180", about: "È´îÈ©óÊ∞¥Âç†Âçú„ÄÇ" }}
            ]},
            4: { city: "Hyogo", items: [
                { t: "13:35", d: "Âß¨Ë∑ØÂüé", type: "SIGHT", m: "Himeji Castle", detail: { address: "ÂÖµÂ∫´Á∏£Âß¨Ë∑ØÂ∏ÇÊú¨Áî∫68", about: "‰∏ñÁïåÈÅ∫Áî¢ÔºåÁôΩÈ∑∫Âüé„ÄÇ" }}
            ]},
            5: { city: "Osaka", items: [
                { t: "07:00", d: "ü•ê È£ØÂ∫óÊó©È§ê", type: "FOOD", m: "Respire", r: "ÊÇ†ÈñíÊó©È§êÂæåÊ∫ñÂÇôËøîÂè∞„ÄÇ" },
                { t: "12:20", d: "ÊòüÂÆáËà™Á©∫ JX821", type: "FLIGHT", m: "ÈóúË•øÊ©üÂ†¥ (KIX)", detail: { booking: "JX-821-RET" }}
            ]}
        };

        const cityCoords = { "Osaka": { lat: 34.69, lon: 135.50 }, "Kyoto": { lat: 35.01, lon: 135.76 }, "Hyogo": { lat: 34.81, lon: 134.69 } };

        // --- Â§©Ê∞£ & Ë°åÁ®ã ---
        async function fetchWeather(city) {
            const coord = cityCoords[city] || cityCoords["Osaka"];
            const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${coord.lat}&longitude=${coord.lon}&hourly=temperature_2m,weathercode&timezone=Asia%2FTokyo&forecast_days=1`);
            const data = await res.json();
            document.getElementById('weather-city').innerText = city;
            document.getElementById('hourly-weather').innerHTML = data.hourly.temperature_2m.slice(0, 24).filter((_, i) => i % 4 === 0).map((temp, i) => `
                <div class="flex-1 text-center">
                    <div class="text-[8px] text-gray-300 uppercase mb-1">${i*4}:00</div>
                    <div class="text-xs mb-1">${data.hourly.weathercode[i*4] <= 3 ? '‚òÄÔ∏è' : '‚òÅÔ∏è'}</div>
                    <div class="text-[10px] font-bold serif">${Math.round(temp)}¬∞</div>
                </div>`).join('');
        }

        function showDay(day) {
            const data = travelData[day];
            fetchWeather(data.city);
            let html = '<div class="timeline-line"></div>';
            data.items.forEach((item, idx) => {
                html += `<div class="timeline-item" onclick="openDetail(${day}, ${idx})">
                    <div class="time-side serif">${item.t.split(':')[0]}<span class="text-[10px] text-gray-200">¬∞</span></div>
                    <div class="content-side">
                        <div class="text-[8px] text-gray-300 font-bold mb-1 uppercase">${item.type}</div>
                        <h4 class="text-sm font-bold text-gray-800">${item.d}</h4>
                        <p class="text-[10px] text-gray-400 mt-1">${item.m}</p>
                    </div>
                </div>`;
            });
            document.getElementById('day-content').innerHTML = html;
            document.querySelectorAll('.day-btn').forEach((b, i) => b.classList.toggle('active', i+1===day));
        }

        function openDetail(day, idx) {
            const item = travelData[day].items[idx];
            const detail = item.detail || {};
            let bodyHtml = `<div class="flex items-center gap-2 mb-2"><span class="text-[9px] bg-black text-white px-2 py-1 font-bold uppercase">${item.type}</span><span class="text-xs serif">${item.t}</span></div><h2 class="text-xl font-bold serif">${item.d}</h2>`;
            if(detail.address) bodyHtml += `<div class="flex items-start gap-2 text-[10px] text-gray-400 underline mt-2" onclick="navigate('${detail.address}')"><i class="fas fa-map-marker-alt mt-0.5"></i><span>${detail.address}</span></div>`;
            if(detail.booking) bodyHtml += `<div class="bg-gray-50 border border-dashed p-3 rounded-xl mt-4"><div class="text-[8px] text-gray-300 font-bold uppercase mb-1 tracking-widest">Booking Ref</div><div class="text-xs font-bold serif">${detail.booking}</div></div>`;
            if(detail.about) bodyHtml += `<p class="text-[11px] text-gray-500 mt-4 leading-relaxed">${detail.about}</p>`;
            document.getElementById('modal-body').innerHTML = bodyHtml;
            document.getElementById('infoModal').style.display = 'block';
        }
        function closeModal() { document.getElementById('infoModal').style.display = 'none'; }

        // --- ‰ª£Ë≥ºÊ∏ÖÂñÆÈÇèËºØ (ÂÖ®Êñ∞) ---
        let shops = JSON.parse(localStorage.getItem('trip_shop_v9')) || [];
        let currentFilter = 'All';
        let tempImg = null;

        function addShoppingItem() {
            const name = document.getElementById('shop-name').value;
            const loc = document.getElementById('shop-loc').value || 'Êú™ÂÆöÂú∞Èªû';
            if(!name) return alert("Ë´ãËº∏ÂÖ•ÂêçÁ®±");
            
            shops.unshift({
                id: Date.now(),
                name: name,
                spec: document.getElementById('shop-spec').value,
                qty: document.getElementById('shop-qty').value || 1,
                loc: loc,
                img: tempImg,
                purchased: false,
                price: ""
            });
            localStorage.setItem('trip_shop_v9', JSON.stringify(shops));
            tempImg = null;
            document.getElementById('shop-name').value = '';
            document.getElementById('shop-spec').value = '';
            document.getElementById('shop-qty').value = '';
            renderShop();
        }

        function renderShop() {
            // 1. ÁîüÊàêÁØ©ÈÅ∏ÊåâÈàï
            const locations = ['All', ...new Set(shops.map(s => s.loc))];
            document.getElementById('shop-filter-bar').innerHTML = locations.map(l => `
                <button onclick="setShopFilter('${l}')" class="filter-btn text-[10px] px-4 py-1.5 rounded-full border transition-all ${currentFilter === l ? 'active' : 'bg-white text-gray-400'}">${l}</button>
            `).join('');

            // 2. Ê∏≤ÊüìÊ∏ÖÂñÆ
            const filtered = currentFilter === 'All' ? shops : shops.filter(s => s.loc === currentFilter);
            document.getElementById('shopping-list').innerHTML = filtered.map(s => `
                <div class="bg-white p-4 rounded-3xl border border-gray-100 shadow-sm flex flex-col gap-3 ${s.purchased ? 'purchased-item' : ''}">
                    <div class="flex items-start gap-4">
                        <div class="w-14 h-14 bg-gray-50 rounded-2xl bg-cover bg-center flex-shrink-0" style="background-image:url(${s.img || ''})"></div>
                        <div class="flex-1">
                            <div class="flex justify-between items-start">
                                <h4 class="text-sm font-bold item-title">${s.name}</h4>
                                <button onclick="delShop(${s.id})" class="text-gray-200 text-xs"><i class="fas fa-trash-alt"></i></button>
                            </div>
                            <div class="text-[10px] text-gray-400 mt-0.5">${s.spec} | Êï∏Èáè: ${s.qty}</div>
                            <div class="text-[9px] bg-indigo-50 text-indigo-400 inline-block px-2 py-0.5 rounded-full mt-2"><i class="fas fa-store mr-1"></i>${s.loc}</div>
                        </div>
                    </div>
                    
                    <div class="flex items-center justify-between border-t pt-3 mt-1">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" ${s.purchased ? 'checked' : ''} onchange="togglePurchased(${s.id})" class="w-4 h-4 rounded-full accent-indigo-900">
                            <span class="text-[10px] font-bold text-gray-500 uppercase tracking-tighter">Bought</span>
                        </label>
                        <div class="flex items-center gap-2">
                            <span class="text-[9px] text-gray-300">¬•</span>
                            <input type="number" value="${s.price}" onblur="updatePrice(${s.id}, this.value)" placeholder="‰ª£Ë≥ºÈáëÈ°ç" class="w-20 border-b border-gray-100 text-xs text-right outline-none bg-transparent">
                        </div>
                    </div>
                </div>`).join('');
        }

        function setShopFilter(l) { currentFilter = l; renderShop(); }
        function togglePurchased(id) { 
            const idx = shops.findIndex(s => s.id === id);
            shops[idx].purchased = !shops[idx].purchased;
            saveAndRenderShop();
        }
        function updatePrice(id, val) {
            const idx = shops.findIndex(s => s.id === id);
            shops[idx].price = val;
            saveAndRenderShop();
        }
        function delShop(id) { shops = shops.filter(s => s.id !== id); saveAndRenderShop(); }
        function saveAndRenderShop() { localStorage.setItem('trip_shop_v9', JSON.stringify(shops)); renderShop(); }

        // --- Ë®òÂ∏≥ & Êñá‰ª∂ (Á∂≠ÊåÅÂéüÊúâÈÇèËºØ) ---
        let exps = JSON.parse(localStorage.getItem('tr_exp_v9')) || [];
        function addExpense() {
            exps.unshift({ id: Date.now(), name: document.getElementById('exp-name').value, amt: document.getElementById('exp-amount').value, method: document.getElementById('exp-method').value, date: document.getElementById('exp-date').value });
            localStorage.setItem('tr_exp_v9', JSON.stringify(exps));
            renderLedger();
        }
        function renderLedger() {
            let total = 0;
            document.getElementById('expense-list').innerHTML = exps.map(e => {
                total += Number(e.amt);
                return `<div class="bg-white p-3 border-b flex justify-between items-center"><div class="text-[11px] font-bold">${e.name}<div class="text-[8px] text-gray-300">${e.method}</div></div><div class="flex items-center gap-4"><span class="serif font-bold text-xs">¬•${e.amt}</span><button onclick="delExp(${e.id})" class="text-gray-100">‚úï</button></div></div>`;
            }).join('');
            document.querySelector('#total-amount span').innerText = `¬•${total}`;
        }
        function delExp(id) { exps = exps.filter(e => e.id !== id); localStorage.setItem('tr_exp_v9', JSON.stringify(exps)); renderLedger(); }

        let docs = JSON.parse(localStorage.getItem('tr_doc_v9')) || [];
        function addDoc() {
            docs.unshift({ id: Date.now(), name: document.getElementById('doc-name').value, img: tempImg });
            localStorage.setItem('tr_doc_v9', JSON.stringify(docs));
            renderDocs();
        }
        function renderDocs() {
            document.getElementById('doc-list').innerHTML = docs.map(d => `<div class="bg-white p-4 rounded-2xl border flex justify-between items-center shadow-sm"><div class="text-[11px] font-bold">${d.name}</div><div class="flex gap-4"><button onclick="viewImg('${d.img}')" class="text-[10px] font-bold text-blue-400">VIEW</button><button onclick="delDoc(${d.id})" class="text-gray-100">‚úï</button></div></div>`).join('');
        }
        function delDoc(id) { docs = docs.filter(d => d.id !== id); localStorage.setItem('tr_doc_v9', JSON.stringify(docs)); renderDocs(); }

        function processImage(input) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = 500; canvas.height = (img.height/img.width)*500;
                    canvas.getContext('2d').drawImage(img, 0, 0, 500, canvas.height);
                    tempImg = canvas.toDataURL('image/jpeg', 0.5);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(input.files[0]);
        }
        function switchTab(t) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(t).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('nav-active'));
            event.currentTarget.classList.add('nav-active');
        }
        function navigate(l) { window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(l)}`, '_blank'); }
        function viewImg(s) { const w = window.open(""); w.document.write(`<img src="${s}" style="width:100%">`); }

        // ÂàùÂßãÂåñ
        showDay(1); renderShop(); renderLedger(); renderDocs();
        document.getElementById('exp-date').valueAsDate = new Date();
		
		// --- Google Sheets ‰∏≤Êé•Ë®≠ÂÆö ---
		const GAS_URL = "https://script.google.com/macros/s/AKfycbyGp06WIA8lErXczy52gkYg1AIayK5DsSzb-O_-JCT5xa282L-bEPNagHxxZap5Hip4/exec"; 
		
		async function syncToSheets(type, data) {
			if (!GAS_URL.includes("exec")) return; // Â¶ÇÊûúÊ≤íË®≠ URL Â∞±‰∏çÂü∑Ë°å
			try {
				await fetch(GAS_URL, {
					method: "POST",
					mode: 'no-cors', // Ëß£Ê±∫Ë∑®Á∂≤ÂüüÂïèÈ°å
					body: JSON.stringify({ type: type, data: data })
				});
				console.log(`Sync Success: ${type}`);
			} catch (e) {
				console.error("Sync Error", e);
			}
		}
		
		// --- ‰øÆÊîπÂæåÁöÑÂÑ≤Â≠òËàáÂà™Èô§ÂáΩÊï∏ ---
		
		// 1. ‰ª£Ë≥ºÈ†ÖÁõÆÊñ∞Â¢û
		function addShoppingItem() {
			const name = document.getElementById('shop-name').value;
			const loc = document.getElementById('shop-loc').value || 'Êú™ÂÆöÂú∞Èªû';
			const purchaser = document.getElementById('shop-purchaser').value || 'Êú™ÊåáÂÆö';
			
			if(!name) return alert("Ë´ãËº∏ÂÖ•ÂïÜÂìÅÂêçÁ®±");
			
			const newItem = {
				id: Date.now(),
				name: name,
				spec: document.getElementById('shop-spec').value,
				qty: document.getElementById('shop-qty').value || 1,
				loc: loc,
				purchaser: purchaser, // Êñ∞Â¢ûÊ¨Ñ‰Ωç
				img: tempImg,
				purchased: false,
				price: ""
			};
			
			shops.unshift(newItem);
			saveAndRenderShop();
			syncToSheets("shop", newItem); // ÂêåÊ≠•Âà∞ Sheets
			
			// Ê∏ÖÁ©∫Ëº∏ÂÖ•
			document.getElementById('shop-name').value = '';
			document.getElementById('shop-spec').value = '';
			document.getElementById('shop-qty').value = '';
			document.getElementById('shop-loc').value = '';
			document.getElementById('shop-purchaser').value = '';
			tempImg = null;
			document.getElementById('shop-img-status').innerText = "‰∏äÂÇ≥ÂèÉËÄÉÂúñÁâá";
		}
		// 2. Ê∏≤ÊüìÊ∏ÖÂñÆ (È°ØÁ§∫Ë≥ºË≤∑ËÄÖ)
		function renderShop() {
			// ÁîüÊàêÁØ©ÈÅ∏ÊåâÈàï (Áï•...)
			const locations = ['All', ...new Set(shops.map(s => s.loc))];
			document.getElementById('shop-filter-bar').innerHTML = locations.map(l => `
				<button onclick="setShopFilter('${l}')" class="filter-btn text-[10px] px-4 py-1.5 rounded-full border transition-all ${currentFilter === l ? 'active' : 'bg-white text-gray-400'}">${l}</button>
			`).join('');
		
			// Ê∏≤ÊüìÊ∏ÖÂñÆ
			const filtered = currentFilter === 'All' ? shops : shops.filter(s => s.loc === currentFilter);
			document.getElementById('shopping-list').innerHTML = filtered.map(s => `
				<div class="bg-white p-4 rounded-3xl border border-gray-100 shadow-sm flex flex-col gap-3 ${s.purchased ? 'purchased-item' : ''}">
					<div class="flex items-start gap-4">
						<div class="w-14 h-14 bg-gray-50 rounded-2xl bg-cover bg-center flex-shrink-0" style="background-image:url(${s.img || ''})"></div>
						<div class="flex-1">
							<div class="flex justify-between items-start">
								<h4 class="text-sm font-bold item-title">${s.name}</h4>
								<button onclick="delShop(${s.id})" class="text-gray-200 text-xs"><i class="fas fa-trash-alt"></i></button>
							</div>
							<div class="text-[10px] text-gray-400 mt-0.5">${s.spec} | Êï∏Èáè: ${s.qty}</div>
							
							<!-- È°ØÁ§∫Â†¥ÊâÄËàáË≥ºË≤∑ËÄÖ -->
							<div class="flex flex-wrap gap-2 mt-2">
								<div class="text-[9px] bg-indigo-50 text-indigo-400 px-2 py-0.5 rounded-full"><i class="fas fa-store mr-1"></i>${s.loc}</div>
								<div class="text-[9px] bg-gray-100 text-gray-500 px-2 py-0.5 rounded-full"><i class="fas fa-user mr-1"></i>${s.purchaser}</div>
							</div>
						</div>
					</div>
					
					<div class="flex items-center justify-between border-t pt-3 mt-1">
						<label class="flex items-center gap-2 cursor-pointer">
							<input type="checkbox" ${s.purchased ? 'checked' : ''} onchange="togglePurchased(${s.id})" class="w-4 h-4 rounded-full accent-indigo-900">
							<span class="text-[10px] font-bold text-gray-500 uppercase tracking-tighter">Bought</span>
						</label>
						<div class="flex items-center gap-2">
							<span class="text-[9px] text-gray-300">¬•</span>
							<input type="number" value="${s.price}" onblur="updatePrice(${s.id}, this.value)" placeholder="‰ª£Ë≥ºÈáëÈ°ç" class="w-20 border-b border-gray-100 text-xs text-right outline-none bg-transparent">
						</div>
					</div>
				</div>`).join('');
		}

		
		// 3. ‰ª£Ë≥ºÁãÄÊÖãÊõ¥Êñ∞ (ÂãæÈÅ∏ËàáÈáëÈ°ç)
		function togglePurchased(id) { 
			const idx = shops.findIndex(s => s.id === id);
			shops[idx].purchased = !shops[idx].purchased;
			saveAndRenderShop();
			syncToSheets("shop", shops[idx]); // ÂêåÊ≠•Êõ¥Êñ∞ÁãÄÊÖãÂà∞ Sheets
		}
		
		function updatePrice(id, val) {
			const idx = shops.findIndex(s => s.id === id);
			shops[idx].price = val;
			saveAndRenderShop();
			syncToSheets("shop", shops[idx]); // ÂêåÊ≠•Êõ¥Êñ∞ÂÉπÊ†ºÂà∞ Sheets
		}
		
		// 4. Ë®òÂ∏≥Êñ∞Â¢û
		function addExpense() {
			const name = document.getElementById('exp-name').value;
			const amt = document.getElementById('exp-amount').value;
			const method = document.getElementById('exp-method').value;
			const date = document.getElementById('exp-date').value;
			if(!name || !amt) return;
		
			const newExp = { id: Date.now(), name, amt, method, date };
			exps.unshift(newExp);
			localStorage.setItem('tr_exp_v9', JSON.stringify(exps));
			renderLedger();
			syncToSheets("exp", newExp); // ÂêåÊ≠•Âà∞ Sheets
			
			document.getElementById('exp-name').value = '';
			document.getElementById('exp-amount').value = '';
		}
		
		// 5. Âà™Èô§ÂêåÊ≠•
		function delShop(id) {
			const itemToDelete = shops.find(s => s.id === id);
			shops = shops.filter(s => s.id !== id);
			saveAndRenderShop();
			syncToSheets("del_shop", { id: id }); // Âæû Sheets Âà™Èô§
		}
		
		function delExp(id) {
			exps = exps.filter(e => e.id !== id);
			localStorage.setItem('tr_exp_v9', JSON.stringify(exps));
			renderLedger();
			syncToSheets("del_exp", { id: id }); // Âæû Sheets Âà™Èô§
		}
    </script>
</body>
</html>