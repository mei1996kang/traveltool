<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 Osaka Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #fdfdfd; --main: #333; --blue: #1a2a6c; }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: var(--bg); color: var(--main); line-height: 1.5; }
        .serif { font-family: 'Playfair Display', serif; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }

        /* 行程佈局 */
        .timeline-item { position: relative; display: flex; padding-bottom: 2rem; }
        .time-side { width: 60px; flex-shrink: 0; text-align: right; padding-right: 15px; font-size: 1.1rem; font-weight: 700; position: relative; }
        .time-side::after { content: ''; position: absolute; right: -1px; top: 10px; width: 7px; height: 7px; background: white; border: 1px solid #ccc; border-radius: 50%; z-index: 10; }
        .timeline-line { position: absolute; left: 59.5px; top: 10px; bottom: 0; width: 1px; background: #eee; }
        .content-side { flex: 1; padding-left: 15px; }

        /* 彈窗 */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(5px); }
        .modal-content { background: white; margin: 10% auto; width: 90%; max-width: 400px; border-radius: 20px; max-height: 80vh; overflow-y: auto; }

        /* 導覽列 */
        .nav-active { color: var(--blue) !important; font-weight: 700; }
        .day-btn.active { color: #111; font-weight: 700; border-bottom: 2px solid #111; }
        .purchased-item { opacity: 0.5; filter: grayscale(1); }
    </style>
</head>
<body class="pb-24">

    <!-- 全螢幕 Loading 遮罩 (初始顯示，載入完隱藏) -->
    <div id="loading-overlay" class="fixed inset-0 bg-white z-[2000] flex items-center justify-center">
        <div class="text-center">
            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-indigo-900 mx-auto"></div>
            <p class="mt-4 text-xs text-gray-400 tracking-widest uppercase">Initializing...</p>
        </div>
    </div>

    <header class="p-6 text-center">
        <div class="text-[9px] text-gray-400 tracking-[0.4em] mb-1 font-light uppercase">Osaka Trip</div>
        <h1 class="text-xl font-bold tracking-widest serif">大阪 ● 京都 ● 兵庫</h1>
    </header>

    <div id="infoModal" class="modal" onclick="closeModal()"><div class="modal-content p-8" onclick="event.stopPropagation()"><div id="modal-body" class="space-y-4"></div></div></div>

    <!-- 1. 行程 -->
    <div id="itinerary" class="tab-content active px-6">
        <div class="flex justify-between mb-8 overflow-x-auto hide-scrollbar space-x-6 px-2 text-gray-300">
            <button onclick="showDay(1)" class="day-btn pb-1 min-w-fit"><span class="text-[9px] block">MON</span><span class="text-lg serif">2/2</span></button>
            <button onclick="showDay(2)" class="day-btn pb-1 min-w-fit"><span class="text-[9px] block">TUE</span><span class="text-lg serif">2/3</span></button>
            <button onclick="showDay(3)" class="day-btn pb-1 min-w-fit"><span class="text-[9px] block">WED</span><span class="text-lg serif">2/4</span></button>
            <button onclick="showDay(4)" class="day-btn pb-1 min-w-fit"><span class="text-[9px] block">THU</span><span class="text-lg serif">2/5</span></button>
            <button onclick="showDay(5)" class="day-btn pb-1 min-w-fit"><span class="text-[9px] block">FRI</span><span class="text-lg serif">2/6</span></button>
        </div>
        <div id="weather-section" class="mb-8 text-center border-y py-4 text-gray-400">
            <h2 id="weather-city" class="text-[10px] tracking-widest uppercase mb-4">Weather</h2>
            <div id="hourly-weather" class="flex space-x-4 overflow-x-auto hide-scrollbar"></div>
        </div>
        <div id="day-content" class="relative"></div>
    </div>

    <!-- 2. 代購 -->
    <div id="shopping" class="tab-content p-6">
        <div class="bg-white p-6 rounded-3xl border mb-6 text-sm">
            <h3 class="text-[10px] font-bold mb-4 text-gray-300 uppercase tracking-widest">Add Wish</h3>
            <div class="space-y-3">
                <input type="text" id="shop-name" placeholder="商品名稱" class="w-full border-b py-2 outline-none">
                <div class="grid grid-cols-2 gap-4">
                    <input type="text" id="shop-spec" placeholder="規格" class="w-full border-b py-2 outline-none">
                    <input type="number" id="shop-qty" placeholder="數量" class="w-full border-b py-2 outline-none">
                </div>
                <input type="text" id="shop-loc" placeholder="場所" class="w-full border-b py-2 outline-none">
                <input type="text" id="shop-purchaser" placeholder="購買者" class="w-full border-b py-2 outline-none">
                <label class="block border border-dashed py-4 text-center rounded-2xl text-gray-400 text-[10px]">
                    <i class="fas fa-camera mr-2"></i>上傳圖片
                    <input type="file" accept="image/*" class="hidden" onchange="processImage(this)">
                </label>
                <button onclick="addShoppingItem()" class="w-full bg-black text-white py-4 rounded-full text-xs font-bold tracking-widest">ADD ITEM</button>
            </div>
        </div>
        <div id="shop-filter-bar" class="flex space-x-2 overflow-x-auto hide-scrollbar mb-4"></div>
        <div id="shopping-list" class="space-y-4"></div>
    </div>

    <!-- 3. 記帳 -->
    <div id="ledger" class="tab-content p-6">
        <div class="bg-white p-6 rounded-3xl border mb-6">
            <h3 class="text-[10px] font-bold mb-4 text-gray-300 uppercase tracking-widest">Ledger</h3>
            <div class="grid grid-cols-2 gap-4 text-sm">
                <input type="text" id="exp-name" placeholder="項目" class="border-b py-2 outline-none">
                <input type="number" id="exp-amount" placeholder="金額 ¥" class="border-b py-2 outline-none">
                <select id="exp-method" class="border-b py-2 bg-transparent outline-none"><option>現金</option><option>刷卡</option><option>Suica</option></select>
                <input type="date" id="exp-date" class="border-b py-2 outline-none">
            </div>
            <button onclick="addExpense()" class="w-full bg-black text-white py-4 rounded-full text-xs font-bold mt-6">SAVE</button>
        </div>
        <div id="expense-list" class="space-y-2"></div>
        <div id="total-amount" class="mt-8 text-right font-light text-xl">Total <span class="serif text-4xl font-bold ml-2">¥0</span></div>
    </div>

    <!-- 4. 文件 -->
    <div id="tickets" class="tab-content p-6">
        <div class="bg-white p-6 rounded-3xl border mb-6">
            <h3 class="text-[10px] font-bold mb-4 text-gray-300 uppercase tracking-widest">Documents</h3>
            <input type="text" id="doc-name" placeholder="標題" class="w-full border-b py-2 text-sm outline-none mb-4">
            <label class="block border border-dashed py-6 text-center rounded-2xl text-gray-400 text-[10px]">上傳截圖 <input type="file" accept="image/*" class="hidden" onchange="processImage(this)"></label>
            <button onclick="addDoc()" class="w-full bg-black text-white py-4 rounded-full text-xs font-bold mt-4 uppercase">Upload</button>
        </div>
        <div id="doc-list" class="space-y-3"></div>
    </div>

    <!-- Nav -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-md border-t flex justify-around p-4 safe-area-bottom z-[1000]">
        <button onclick="switchTab('itinerary')" class="nav-btn flex flex-col items-center nav-active text-gray-300"><i class="fas fa-stream"></i><span class="text-[9px] mt-1">PLAN</span></button>
        <button onclick="switchTab('shopping')" class="nav-btn flex flex-col items-center text-gray-300"><i class="fas fa-shopping-cart"></i><span class="text-[9px] mt-1">SHOP</span></button>
        <button onclick="switchTab('ledger')" class="nav-btn flex flex-col items-center text-gray-300"><i class="fas fa-wallet"></i><span class="text-[9px] mt-1">CASH</span></button>
        <button onclick="switchTab('tickets')" class="nav-btn flex flex-col items-center text-gray-300"><i class="fas fa-folder"></i><span class="text-[9px] mt-1">DOCS</span></button>
    </nav>

    <script>
        // --- 設定 (請務必填寫) ---
        const GAS_URL = "https://script.google.com/macros/s/AKfycbzEv6Bda3jKfHZNoV-duexjmNT47igMmz0s_Ldm7fRyR23TH619rqp3bzYd9jXUT0yO/exec"; 

        // --- 全域變數 ---
        let shops = JSON.parse(localStorage.getItem('tr_shop_v10')) || [];
        let exps = JSON.parse(localStorage.getItem('tr_exp_v10')) || [];
        let docs = JSON.parse(localStorage.getItem('tr_doc_v10')) || [];
        let currentFilter = 'All';
        let tempImg = null;

        const travelData = {
            1: { city: "Osaka", title: "2/2 Mon | 抵達日本", items: [{ t: "09:20", d: "星宇航空 JX822", type: "FLIGHT", m: "桃園機場", detail: { booking: "JX-822", about: "預計 12:50 抵達 KIX" }}, { t: "13:56", d: "臨空城 Outlet", type: "SHOP", m: "Rinku Town" }, { t: "19:25", d: "難波飯店入住", type: "HOTEL", m: "GRIDS PREMIUM" }]},
            2: { city: "Kyoto", title: "2/3 Tue | 海之京都", items: [{ t: "07:15", d: "KKDAY 巴士集合", type: "TRANS", m: "日本橋" }, { t: "11:00", d: "天橋立 傘松公園", type: "SIGHT", m: "Amanohashidate" }, { t: "19:00", d: "梅田飯店入住", type: "HOTEL", m: "Respire" }]},
            3: { city: "Kyoto", title: "2/4 Wed | 貴船參拜", items: [{ t: "14:40", d: "貴船神社", type: "SIGHT", m: "Kifune" }]},
            4: { city: "Hyogo", title: "2/5 Thu | 姬路巡禮", items: [{ t: "13:35", d: "姬路城", type: "SIGHT", m: "Himeji Castle" }]},
            5: { city: "Osaka", title: "2/6 Fri | 賦歸", items: [{ t: "07:00", d: "飯店早餐", type: "FOOD", m: "Respire" }, { t: "12:20", d: "星宇 JX821", type: "FLIGHT", m: "KIX" }]}
        };

        const cityCoords = { "Osaka": { lat: 34.69, lon: 135.50 }, "Kyoto": { lat: 35.01, lon: 135.76 }, "Hyogo": { lat: 34.81, lon: 134.69 } };

        // --- 核心函數 ---

        async function initData() {
            try {
                // 1. 先從本地渲染畫面 (防卡死)
                showDay(1);
                renderShop();
                renderLedger();
                renderDocs();
                
                // 2. 隱藏 Loading
                document.getElementById('loading-overlay').classList.add('hidden');

                // 3. 背景執行雲端同步
                if (GAS_URL.includes("https")) {
                    console.log("正在同步雲端...");
                    const res = await fetch(GAS_URL, { signal: AbortSignal.timeout(5000) });
                    const cloud = await res.json();
                    if (cloud.shops) { shops = cloud.shops; localStorage.setItem('tr_shop_v10', JSON.stringify(shops)); renderShop(); }
                    if (cloud.exps) { exps = cloud.exps; localStorage.setItem('tr_exp_v10', JSON.stringify(exps)); renderLedger(); }
                    console.log("雲端同步完成");
                }
            } catch (e) {
                console.error("初始化失敗:", e);
                document.getElementById('loading-overlay').classList.add('hidden');
            }
        }

        async function syncToSheets(type, data) {
            if (!GAS_URL.includes("https")) return;
            let syncData = JSON.parse(JSON.stringify(data));
            if (syncData.img && syncData.img.length > 40000) syncData.img = "Image too large";
            try { fetch(GAS_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ type, data: syncData }) }); } catch (e) {}
        }

        function showDay(day) {
            const data = travelData[day];
            let html = '<div class="timeline-line"></div>';
            data.items.forEach((item, idx) => {
                html += `<div class="timeline-item" onclick="openDetail(${day}, ${idx})">
                    <div class="time-side serif">${item.t.split(':')[0]}<span class="text-[8px] text-gray-300">°</span></div>
                    <div class="content-side">
                        <div class="text-[8px] text-gray-300 font-bold uppercase mb-1 tracking-tighter">${item.type}</div>
                        <h4 class="text-sm font-bold text-gray-800">${item.d}</h4>
                        <p class="text-[10px] text-gray-400 mt-1">${item.m}</p>
                    </div>
                </div>`;
            });
            document.getElementById('day-content').innerHTML = html;
            document.querySelectorAll('.day-btn').forEach((b, i) => b.classList.toggle('active', i+1===day));
            fetchWeather(data.city);
        }

        async function fetchWeather(city) {
            try {
                const c = cityCoords[city];
                const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${c.lat}&longitude=${c.lon}&hourly=temperature_2m&timezone=Asia%2FTokyo&forecast_days=1`);
                const data = await res.json();
                document.getElementById('weather-city').innerText = city;
                document.getElementById('hourly-weather').innerHTML = data.hourly.temperature_2m.slice(0, 24).filter((_, i) => i % 4 === 0).map((t, i) => `<div class="flex-1 text-center"><div class="text-[8px] mb-1 uppercase">${i*4}:00</div><div class="text-xs font-bold serif">${Math.round(t)}°</div></div>`).join('');
            } catch (e) {}
        }

        function renderShop() {
            const locs = ['All', ...new Set(shops.map(s => s.loc || '未定'))];
            document.getElementById('shop-filter-bar').innerHTML = locs.map(l => `<button onclick="setFilter('${l}')" class="text-[10px] px-3 py-1 rounded-full border ${currentFilter === l ? 'bg-black text-white' : 'bg-white text-gray-400'}">${l}</button>`).join('');
            const filtered = currentFilter === 'All' ? shops : shops.filter(s => s.loc === currentFilter);
            document.getElementById('shopping-list').innerHTML = filtered.map(s => {
                let img = s.img || '';
                if (img && !img.startsWith('data:')) img = 'data:image/jpeg;base64,' + img;
                return `<div class="bg-white p-4 rounded-3xl border shadow-sm flex flex-col gap-3 ${s.purchased ? 'purchased-item' : ''}">
                    <div class="flex gap-4">
                        <div class="w-14 h-14 bg-gray-50 rounded-2xl bg-cover bg-center flex-shrink-0" style="background-image:url('${img}')" onclick="viewImg('${img}')"></div>
                        <div class="flex-1">
                            <div class="flex justify-between font-bold text-sm"><span>${s.name}</span><button onclick="delShop(${s.id})">✕</button></div>
                            <div class="text-[10px] text-gray-400 mt-1">${s.spec || ''} | 數量: ${s.qty || 1}</div>
                            <div class="flex gap-2 mt-2 text-[8px] font-bold">
                                <span class="bg-indigo-50 text-indigo-400 px-2 py-0.5 rounded-full">${s.loc || '未定'}</span>
                                <span class="bg-gray-100 text-gray-400 px-2 py-0.5 rounded-full">${s.purchaser || '未指定'}</span>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-between items-center border-t pt-3">
                        <input type="checkbox" ${s.purchased ? 'checked' : ''} onchange="toggleShop(${s.id})" class="accent-black">
                        <div class="text-xs">¥ <input type="number" value="${s.price || ''}" onblur="updateShopPrice(${s.id}, this.value)" class="w-16 border-b text-right outline-none"></div>
                    </div>
                </div>`;
            }).join('');
        }

        function addShoppingItem() {
            const name = document.getElementById('shop-name').value;
            if (!name) return;
            const item = { id: Date.now(), name, spec: document.getElementById('shop-spec').value, qty: document.getElementById('shop-qty').value, loc: document.getElementById('shop-loc').value, purchaser: document.getElementById('shop-purchaser').value, img: tempImg, purchased: false, price: "" };
            shops.unshift(item);
            localStorage.setItem('tr_shop_v10', JSON.stringify(shops));
            renderShop();
            syncToSheets("shop", item);
            document.getElementById('shop-name').value = ''; tempImg = null;
        }

        function toggleShop(id) { const i = shops.findIndex(s => s.id === id); shops[i].purchased = !shops[i].purchased; localStorage.setItem('tr_shop_v10', JSON.stringify(shops)); renderShop(); syncToSheets("shop", shops[i]); }
        function updateShopPrice(id, p) { const i = shops.findIndex(s => s.id === id); shops[i].price = p; localStorage.setItem('tr_shop_v10', JSON.stringify(shops)); syncToSheets("shop", shops[i]); }
        function delShop(id) { shops = shops.filter(s => s.id !== id); localStorage.setItem('tr_shop_v10', JSON.stringify(shops)); renderShop(); syncToSheets("del_shop", {id}); }
        function setFilter(l) { currentFilter = l; renderShop(); }

        function addExpense() {
            const e = { id: Date.now(), name: document.getElementById('exp-name').value, amt: document.getElementById('exp-amount').value, method: document.getElementById('exp-method').value, date: document.getElementById('exp-date').value };
            if (!e.name || !e.amt) return;
            exps.unshift(e); localStorage.setItem('tr_exp_v10', JSON.stringify(exps));
            renderLedger(); syncToSheets("exp", e);
            document.getElementById('exp-name').value = ''; document.getElementById('exp-amount').value = '';
        }
        function renderLedger() {
            let total = 0;
            document.getElementById('expense-list').innerHTML = exps.map(e => {
                total += Number(e.amt);
                return `<div class="bg-white p-3 border-b flex justify-between text-xs"><div><b>${e.name}</b><div class="text-[9px] text-gray-300">${e.method}</div></div><div class="flex items-center gap-4"><b>¥${e.amt}</b><button onclick="delExp(${e.id})" class="text-gray-200">✕</button></div></div>`;
            }).join('');
            document.querySelector('#total-amount span').innerText = `¥${total}`;
        }
        function delExp(id) { exps = exps.filter(e => e.id !== id); localStorage.setItem('tr_exp_v10', JSON.stringify(exps)); renderLedger(); syncToSheets("del_exp", {id}); }

        function addDoc() {
            const d = { id: Date.now(), name: document.getElementById('doc-name').value, img: tempImg };
            if (!d.name || !tempImg) return;
            docs.unshift(d); localStorage.setItem('tr_doc_v10', JSON.stringify(docs));
            renderDocs(); document.getElementById('doc-name').value = ''; tempImg = null;
        }
        function renderDocs() {
            document.getElementById('doc-list').innerHTML = docs.map(d => `<div class="bg-white p-4 rounded-2xl border flex justify-between items-center text-xs"><b>${d.name}</b><div class="flex gap-4"><button onclick="viewImg('${d.img}')" class="text-blue-400">VIEW</button><button onclick="delDoc(${d.id})" class="text-gray-200">✕</button></div></div>`).join('');
        }
        function delDoc(id) { docs = docs.filter(d => d.id !== id); localStorage.setItem('tr_doc_v10', JSON.stringify(docs)); renderDocs(); }

        function processImage(input) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = 400; canvas.height = (img.height/img.width)*400;
                    canvas.getContext('2d').drawImage(img, 0, 0, 400, canvas.height);
                    tempImg = canvas.toDataURL('image/jpeg', 0.4);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(input.files[0]);
        }

        function switchTab(t) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(t).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('nav-active'));
            event.currentTarget.classList.add('nav-active');
        }

        function openDetail(day, idx) {
            const item = travelData[day].items[idx];
            const detail = item.detail || {};
            document.getElementById('modal-body').innerHTML = `
                <h2 class="text-2xl font-bold serif">${item.d}</h2>
                <div class="text-xs text-gray-400 mt-2"><i class="fas fa-clock mr-2"></i>${item.t}</div>
                ${detail.booking ? `<div class="p-4 bg-gray-50 rounded-2xl border-dashed border mt-4 text-xs"><b>Booking:</b> ${detail.booking}</div>` : ''}
                ${detail.about ? `<p class="text-xs text-gray-500 mt-4 leading-relaxed">${detail.about}</p>` : ''}
                <button onclick="navigate('${detail.address || item.d}')" class="w-full bg-black text-white py-4 rounded-full text-xs font-bold mt-6 uppercase">Map Guide</button>
            `;
            document.getElementById('infoModal').style.display = 'block';
        }
        function closeModal() { document.getElementById('infoModal').style.display = 'none'; }
        function viewImg(s) { const w = window.open(""); w.document.write(`<img src="${s}" style="width:100%">`); }
        function navigate(l) { window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(l)}`, '_blank'); }

        // --- 啟動 ---
        window.onload = initData;
    </script>
</body>
</html>