<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 Kansai Handbook</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #fcfaf7; --main: #333; --blue: #1a2a6c; --tag-bg: #f1f5f9; }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: var(--bg); color: var(--main); line-height: 1.6; }
        .serif { font-family: 'Playfair Display', serif; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }

        /* è¡Œç¨‹å…¨é¡¯ç¤ºæ’ç‰ˆ */
        .timeline-item { position: relative; display: flex; padding-bottom: 3rem; }
        .time-side { width: 65px; flex-shrink: 0; text-align: right; padding-right: 15px; font-size: 1.2rem; font-weight: 700; position: relative; color: #111; }
        .time-side::after { content: ''; position: absolute; right: -1px; top: 12px; width: 9px; height: 9px; background: white; border: 1px solid #ddd; border-radius: 50%; z-index: 10; }
        .timeline-line { position: absolute; left: 64.5px; top: 12px; bottom: 0; width: 1px; background: #eee; }
        .content-side { flex: 1; padding-left: 20px; }

        /* ç‰¹è‰²å€å¡Šæ¨£å¼ */
        .feature-box { background: #f0f7ff; border-radius: 8px; padding: 10px; margin-top: 8px; border-left: 3px solid #3b82f6; }
        .eat-box { background: #fff7ed; border-radius: 8px; padding: 10px; margin-top: 8px; border-left: 3px solid #f97316; }
        
        /* é€£çµæ¨£å¼ */
        .link-text { color: #2563eb; text-decoration: underline; word-break: break-all; font-size: 10px; }

        .nav-active { color: var(--blue) !important; font-weight: 700; }
        .day-btn.active { color: #111; font-weight: 700; border-bottom: 2px solid #111; }
        .purchased-item { opacity: 0.5; filter: grayscale(1); }
    </style>
</head>
<body class="pb-24">

    <!-- Loading -->
    <div id="loading-overlay" class="fixed inset-0 bg-white z-[2000] flex items-center justify-center">
        <div class="text-center">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-900 mx-auto"></div>
            <p class="mt-4 text-[10px] text-gray-400 tracking-[0.4em] uppercase">Loading Handbook...</p>
        </div>
    </div>

    <header class="p-6 text-center">
        <div class="text-[9px] text-gray-400 tracking-[0.3em] mb-1 font-light uppercase">Osaka Trip Planner</div>
        <h1 class="text-xl font-bold tracking-widest serif">å¤§é˜ª â— äº¬éƒ½ â— å…µåº« <span class="text-xs font-normal border px-2 py-0.5 rounded-full opacity-40 ml-1">2026</span></h1>
    </header>

    <!-- 1. è¡Œç¨‹ (å…¨å±•é–‹) -->
    <div id="itinerary" class="tab-content active px-6">
        <div class="flex justify-between mb-8 overflow-x-auto hide-scrollbar space-x-6 px-2 text-gray-300">
            <button onclick="showDay(1)" class="day-btn pb-1 min-w-fit"><span class="text-[9px] block">MON</span><span class="text-lg serif">2/2</span></button>
            <button onclick="showDay(2)" class="day-btn pb-1 min-w-fit"><span class="text-[9px] block">TUE</span><span class="text-lg serif">2/3</span></button>
            <button onclick="showDay(3)" class="day-btn pb-1 min-w-fit"><span class="text-[9px] block">WED</span><span class="text-lg serif">2/4</span></button>
            <button onclick="showDay(4)" class="day-btn pb-1 min-w-fit"><span class="text-[9px] block">THU</span><span class="text-lg serif">2/5</span></button>
            <button onclick="showDay(5)" class="day-btn pb-1 min-w-fit"><span class="text-[9px] block">FRI</span><span class="text-lg serif">2/6</span></button>
        </div>

        <div id="weather-section" class="mb-10 text-center border-y border-gray-50 py-4 text-gray-400">
            <h2 id="weather-city" class="text-[10px] tracking-widest uppercase mb-4">Current Weather</h2>
            <div id="hourly-weather" class="flex space-x-4 overflow-x-auto hide-scrollbar"></div>
        </div>

        <div id="day-content" class="relative">
            <!-- è¡Œç¨‹å°‡åœ¨æ­¤å…¨å±•é–‹æ¸²æŸ“ -->
        </div>
    </div>

    <!-- 2. ä»£è³¼ (åŠŸèƒ½èˆ‡ä¹‹å‰ä¸€è‡´) -->
    <div id="shopping" class="tab-content p-6">
        <div class="bg-white p-6 rounded-3xl border border-gray-100 mb-6 text-sm">
            <h3 class="text-[10px] font-bold mb-4 text-gray-300 uppercase tracking-widest">New Wish</h3>
            <div class="space-y-3">
                <input type="text" id="shop-name" placeholder="å•†å“åç¨±" class="w-full border-b py-2 outline-none">
                <div class="grid grid-cols-2 gap-4">
                    <input type="text" id="shop-spec" placeholder="è¦æ ¼" class="w-full border-b py-2 outline-none">
                    <input type="number" id="shop-qty" placeholder="æ•¸é‡" class="w-full border-b py-2 outline-none">
                </div>
                <input type="text" id="shop-loc" placeholder="ä»£è³¼å ´æ‰€" class="w-full border-b py-2 outline-none">
                <input type="text" id="shop-purchaser" placeholder="è³¼è²·è€…" class="w-full border-b py-2 outline-none">
                <label class="block border border-dashed border-gray-200 py-4 text-center rounded-2xl text-gray-400 text-[10px] cursor-pointer">
                    <i class="fas fa-camera mr-2"></i>ä¸Šå‚³åƒè€ƒåœ–ç‰‡
                    <input type="file" accept="image/*" class="hidden" onchange="processImage(this)">
                </label>
                <button onclick="addShoppingItem()" class="w-full bg-black text-white py-4 rounded-full text-[10px] font-bold tracking-widest">ADD ITEM</button>
            </div>
        </div>
        <div id="shop-filter-bar" class="flex space-x-2 overflow-x-auto hide-scrollbar mb-4"></div>
        <div id="shopping-list" class="space-y-4"></div>
    </div>

    <!-- 3. è¨˜å¸³ -->
    <div id="ledger" class="tab-content p-6">
        <div class="bg-white p-6 rounded-3xl border border-gray-100 mb-6 text-sm">
            <h3 class="text-[10px] font-bold mb-4 text-gray-300 uppercase tracking-widest">Expense</h3>
            <div class="grid grid-cols-2 gap-4">
                <input type="text" id="exp-name" placeholder="é …ç›®" class="border-b py-2 outline-none">
                <input type="number" id="exp-amount" placeholder="é‡‘é¡ Â¥" class="border-b py-2 outline-none">
                <select id="exp-method" class="border-b py-2 bg-transparent outline-none"><option>ç¾é‡‘</option><option>åˆ·å¡</option><option>Suica</option></select>
                <input type="date" id="exp-date" class="border-b py-2 outline-none">
            </div>
            <button onclick="addExpense()" class="w-full bg-black text-white py-4 rounded-full text-[10px] font-bold mt-6 uppercase tracking-widest">Save</button>
        </div>
        <div id="expense-list" class="space-y-1"></div>
        <div id="total-amount" class="mt-8 text-right font-light text-xl">Total <span class="serif text-4xl font-bold ml-2">Â¥0</span></div>
    </div>

    <!-- 4. æ–‡ä»¶ -->
    <div id="tickets" class="tab-content p-6">
        <div class="bg-slate-900 text-white p-6 rounded-3xl mb-6 shadow-xl relative overflow-hidden">
            <div class="text-[9px] opacity-40 tracking-[0.4em] mb-4 uppercase">Flight</div>
            <div class="flex justify-between items-center mb-4">
                <div class="text-center"><div class="text-xl font-bold serif">TPE</div><div class="text-[9px] opacity-50">09:20 AM</div></div>
                <div class="flex-1 border-b border-dashed border-white/20 mx-4 relative"><i class="fas fa-plane absolute -top-2 left-1/2 -translate-x-1/2 text-xs text-indigo-300"></i></div>
                <div class="text-center"><div class="text-xl font-bold serif">KIX</div><div class="text-[9px] opacity-50">12:50 PM</div></div>
            </div>
            <div class="text-[8px] text-center opacity-50 uppercase tracking-widest font-bold">Starlux JX822 / JX821</div>
        </div>
        <div id="doc-list" class="space-y-3"></div>
    </div>

    <!-- Nav -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-xl border-t border-gray-100 flex justify-around p-4 safe-area-bottom z-[1000]">
        <button onclick="switchTab('itinerary')" class="nav-btn flex flex-col items-center nav-active text-gray-300"><i class="fas fa-list-ul text-lg"></i><span class="text-[9px] mt-1">PLAN</span></button>
        <button onclick="switchTab('shopping')" class="nav-btn flex flex-col items-center text-gray-300"><i class="fas fa-shopping-cart text-lg"></i><span class="text-[9px] mt-1">SHOP</span></button>
        <button onclick="switchTab('ledger')" class="nav-btn flex flex-col items-center text-gray-300"><i class="fas fa-wallet text-lg"></i><span class="text-[9px] mt-1">CASH</span></button>
        <button onclick="switchTab('tickets')" class="nav-btn flex flex-col items-center text-gray-300"><i class="fas fa-folder-open text-lg"></i><span class="text-[9px] mt-1">DOCS</span></button>
    </nav>

    <script>
        // --- è¨­å®š (è«‹å‹™å¿…å¡«å¯« GAS URL) ---
        const GAS_URL = "https://script.google.com/macros/s/AKfycbzEv6Bda3jKfHZNoV-duexjmNT47igMmz0s_Ldm7fRyR23TH619rqp3bzYd9jXUT0yO/exec"; 

        // --- è¡Œç¨‹è³‡æ–™åº« (æ ¹æ“š PDF å®Œæ•´è§£æ) ---
        const travelData = {
            1: { city: "Osaka", items: [
                { t: "06:30", d: "æ©Ÿå ´æ·é‹(å°åŒ—è»Šç«™)", m: "è¨ˆç¨‹è»Š", b: "æ™‚åˆ»è¡¨é€£çµåœ¨ä¸‹æ–¹", map: "https://maps.app.goo.gl/MW7Zr3WvPaUYwd537", link: "https://www.tymetro.com.tw/tymetro-new/tw/_pages/travel-guide/timetable-search.php" },
                { t: "09:20", d: "âœˆï¸ å‡ºç™¼å‰å¾€é—œè¥¿æ©Ÿå ´", m: "é£›æ©Ÿ", b: "æ­ä¹˜æ˜Ÿå®‡ JX822ã€‚æŠµé” KIX å¾Œé ˜è¡Œæå‰å¾€å—æµ·é›»éµã€‚", map: "https://maps.app.goo.gl/JLbrA5JiHkfwz835A", link: "https://www.howto-osaka.com/tc/access-timetable/" },
                { t: "14:00", d: "ğŸ›ï¸ è‡¨ç©ºåŸ Outlet", m: "å—æµ·é›»éµ", b: "é—œè¥¿æœ€å¤§ç­‰ç´š OUTLETã€‚", map: "https://maps.app.goo.gl/ScyV1p9Va6UDRcrW8", feature: "é£›æ©Ÿè½åœ°ç¬¬ä¸€æ³¢è¡€æ‹¼ã€‚é¢æµ·è¨­è¨ˆå¯çœ‹å¤•é™½ã€‚", buy: "å¿…è²·ï¼šè¥¿æ¾å±‹ã€Onitsuka Tigerã€Nike/Adidasã€Earth Musicã€Colemanã€Crocsã€‚", link: "https://www.premiumoutlets.co.jp/rinku/brands/pdf/rinku.pdf" },
                { t: "19:25", d: "é›£æ³¢ GRIDS HOTEL å…¥ä½", m: "å—æµ·é›»éµ", b: "æ­ä¹˜ç‰¹æ€¥ Rapi:tï¼Œéœ€çª—å£è²·ç¥¨ã€‚", map: "https://maps.app.goo.gl/BYcsfakHzt5pYJwi9" },
                { t: "19:30", d: "ğŸ± æ™šé¤ï¼šå¤§èµ·æ°´ç”¢å£½å¸", m: "å¾’æ­¥", map: "https://maps.app.goo.gl/4ZijhBKwhh4oWKmt6", buy: "å¿…åƒï¼šé»‘é®ªé­šä¸­è…¹ã€ç‚™ç‡’é®­é­šè‚šã€æµ·è†½è»è‰¦ã€èŒ¶ç¢—è’¸ã€‚" },
                { t: "22:30", d: "ğŸœ æ¶ˆå¤œï¼šä¸€è˜­æ‹‰éºµ", m: "å¾’æ­¥", b: "é“é “å €åº—åˆ¥é¤¨æˆ–é›£æ³¢å¾¡å ‚ç­‹åº—", map: "https://maps.app.goo.gl/s4weNpypxEK19rvb9" }
            ]},
            2: { city: "Kyoto", items: [
                { t: "06:55", d: "èŸ¹é“æ¨‚æ±åº—é›†åˆ", m: "å¾’æ­¥", b: "è¡Œæå¯„æ”¾é£¯åº—æ«ƒæª¯ï¼Œææ—©15åˆ†å‡ºé–€ã€‚", map: "https://maps.app.goo.gl/wGSZwfghYPAUpq727" },
                { t: "10:00", d: "ğŸš¢ ä¼Šæ ¹ç£éŠè¦½èˆ¹", m: "å·´å£«", b: "ç´„åœç•™45åˆ†é˜ã€‚", map: "https://maps.app.goo.gl/M1y4cYrxukxZw9AAA", feature: "æ—¥æœ¬ã€ŒèˆŸå±‹ã€ä»£è¡¨ã€‚å¯é¤µæµ·é·—ã€è³ç§˜å¢ƒæµ·è‰²ã€‚" },
                { t: "11:00", d: "ğŸš  å¤©æ©‹ç«‹å‚˜æ¾å…¬åœ’", m: "çºœè»Š", b: "ç´„åœç•™1å°æ™‚ã€‚", map: "https://maps.app.goo.gl/Q2G1kdLTxYXpqwgE6", feature: "æ—¥æœ¬ä¸‰æ™¯ã€Œå€’é ­æ ½ã€è¦–è§’ã€‚", buy: "å¿…åƒï¼šæ™ºæƒ åœ˜å­ã€æŠ¹èŒ¶æ—¥å¼çµ„åˆã€‚" },
                { t: "12:00", d: "ğŸ± å¤©æ©‹ç«‹å‘¨é‚Šåˆé¤", m: "è‡ªç†", b: "åˆé¤æ™‚é–“1.5å°æ™‚ã€‚", buy: "åç‰©ï¼šè›¤èœŠä¸¼(ã‚ã•ã‚Šä¸¼)ã€å†¬å­£æµ·é®®ä¸¼ã€‚" },
                { t: "14:45", d: "ğŸ¡ ç¾å±±èŒ…è‰å±‹ä¹‹é‡Œ", m: "å·´å£«", b: "åŸå§‹èŒ…è‰å±‹èšè½ã€‚", map: "https://maps.app.goo.gl/TGn1n7bdZyGeb33a6", buy: "æ¨è–¦ï¼šæ‰‹å·¥ç±³æœã€åœ¨åœ°å‘³å™Œã€ç¾å±±ç‰›ä¹³ç”œé»ã€‚" },
                { t: "19:40", d: "æ¢…ç”°é¾ä»•æŸé£¯åº—å…¥ä½", m: "åœ°éµ", b: "é›£æ³¢ç«™ â†’ æ¢…ç”°ç«™ã€‚", map: "https://maps.app.goo.gl/LSLKXtng8oKr4Q4QA" }
            ]},
            3: { city: "Kyoto", items: [
                { t: "14:40", d: "â›©ï¸ è²´èˆ¹ç¥ç¤¾åƒæ‹œ", m: "é›»è»Š", b: "äº¬éƒ½æœ€å¤¢å¹»ç¥ç¤¾ã€‚ç©é›ªé…ç‡ˆç± æ¥µç¾ã€‚", map: "https://maps.app.goo.gl/2SeLPrBbPPCxQV1p9", feature: "ç‡ˆç± çŸ³éšã€å¤œé–“é»ç‡ˆæ°£æ°›æ»¿åˆ†ã€‚", buy: "é«”é©—ï¼šæ°´å åœ (æŠŠç±¤æ”¾å…¥æ°´ä¸­)ã€‚" },
                { t: "20:30", d: "ğŸ¥© æ™šé¤ï¼šç‡’è‚‰åŠ›ä¸¸", m: "å¾’æ­¥", b: "å·²é è¨‚20:30 æ¢…ç”°æ±é€šåº—ã€‚", map: "https://maps.app.goo.gl/mSRk6AkBcJV6ta7A", buy: "æ¨è–¦ï¼šå’Œç‰›è‚©èƒ›ã€é¹½è”¥ç‰›èˆŒã€çƒ¤è’œç‰‡ç™½é£¯ã€‚" }
            ]},
            4: { city: "Hyogo", items: [
                { t: "09:30", d: "ğŸ”´ å‹å°¾å¯º", m: "å·´å£«", b: "åƒè§€è‡³11:00ã€‚é–€ç¥¨500æ—¥åœ“ã€‚", map: "https://maps.app.goo.gl/au2qs1mkMEeMs66b8", feature: "ã€Œå‹é‹å¯ºã€ï¼Œéåœ°é”æ‘©éå¸¸å£¯è§€ã€‚", link: "https://www.asoview.com/item/ticket/ticket0000039224/" },
                { t: "13:35", d: "ğŸ¯ å§¬è·¯åŸ", m: "JR", b: "åƒè§€è‡³16:00ã€‚é–€ç¥¨1000æ—¥åœ“ã€‚", map: "https://maps.app.goo.gl/GeWsaaQig2eerPim9", feature: "æ—¥æœ¬ç¬¬ä¸€ååŸï¼Œç™½é·ºåŸä¸–ç•Œéºç”¢ã€‚", buy: "åç‰©ï¼šç™½è‰²å¸ƒä¸ã€å§¬è·¯é—œæ±ç…®ã€æä»åå¸ã€‚" }
            ]},
            5: { city: "Osaka", items: [
                { t: "08:00", d: "ğŸš é£¯åº—å‡ºç™¼", m: "æ¥é€", b: "KKDAY æ©Ÿå ´æ¥é€", map: "https://maps.app.goo.gl/LSLKXtng8oKr4Q4QA" },
                { t: "12:20", d: "âœˆï¸ é—œè¥¿æ©Ÿå ´èµ·é£›", m: "é£›æ©Ÿ", b: "æ˜Ÿå®‡ JX821", map: "https://maps.app.goo.gl/wEwQpbYUt7wF14Vf8" }
            ]}
        };

        const cityCoords = { "Osaka": { lat: 34.69, lon: 135.50 }, "Kyoto": { lat: 35.01, lon: 135.76 }, "Hyogo": { lat: 34.81, lon: 134.69 } };

        // --- åˆå§‹åŒ– ---
        let shops = JSON.parse(localStorage.getItem('tr_shop_v10')) || [];
        let exps = JSON.parse(localStorage.getItem('tr_exp_v10')) || [];
        let currentFilter = 'All';
        let tempImg = null;

        async function initData() {
            showDay(1); renderShop(); renderLedger();
            document.getElementById('loading-overlay').classList.add('hidden');
            if (GAS_URL.includes("https")) {
                try {
                    const res = await fetch(GAS_URL, { signal: AbortSignal.timeout(5000) });
                    const cloud = await res.json();
                    if (cloud.shops) { shops = cloud.shops; localStorage.setItem('tr_shop_v10', JSON.stringify(shops)); renderShop(); }
                    if (cloud.exps) { exps = cloud.exps; localStorage.setItem('tr_exp_v10', JSON.stringify(exps)); renderLedger(); }
                } catch (e) { console.warn("Cloud Sync Timeout"); }
            }
        }

        // --- è¡Œç¨‹æ¸²æŸ“ (å…¨å±•é–‹é‚è¼¯) ---
        function showDay(day) {
            const data = travelData[day];
            let html = '<div class="timeline-line"></div>';
            
            data.items.forEach((it) => {
                html += `
                <div class="timeline-item">
                    <div class="time-side serif">${it.t.split(':')[0]}<span class="text-[8px] text-gray-200">Â°</span></div>
                    <div class="content-side">
                        <div class="flex justify-between items-start">
                            <h4 class="text-sm font-bold text-gray-800">${it.d}</h4>
                            <a href="${it.map}" target="_blank"><i class="fas fa-location-arrow text-red-500 text-xs"></i></a>
                        </div>
                        <div class="text-[10px] text-gray-400 mt-1 flex gap-2">
                            <span class="bg-gray-100 px-1 rounded uppercase font-bold">${it.m}</span>
                            <span>${it.b || ''}</span>
                        </div>
                        ${it.link ? `<div class="mt-1"><a href="${it.link}" class="link-text" target="_blank"><i class="fas fa-link mr-1"></i>ç›¸é—œé€£çµ/æ™‚åˆ»è¡¨/åœ°åœ–</a></div>` : ''}
                        
                        <!-- ç‰¹è‰²é‡é» -->
                        ${it.feature ? `<div class="feature-box">
                            <div class="text-[8px] font-bold text-blue-600 mb-1 tracking-widest"><i class="fas fa-star mr-1"></i>ç‰¹è‰²é‡é»</div>
                            <div class="text-[10px] text-blue-800 leading-relaxed">${it.feature}</div>
                        </div>` : ''}

                        <!-- å¿…è²·å¿…åƒ -->
                        ${it.buy ? `<div class="eat-box">
                            <div class="text-[8px] font-bold text-orange-600 mb-1 tracking-widest"><i class="fas fa-utensils mr-1"></i>å¿…åƒ / å¿…è²· / é«”é©—</div>
                            <div class="text-[10px] text-orange-800 leading-relaxed">${it.buy}</div>
                        </div>` : ''}
                    </div>
                </div>`;
            });
            
            document.getElementById('day-content').innerHTML = html;
            document.querySelectorAll('.day-btn').forEach((b, i) => b.classList.toggle('active', i+1===day));
            fetchWeather(data.city);
        }

        // --- å¤©æ°£ã€ä»£è³¼ã€è¨˜å¸³é‚è¼¯ (ç¶­æŒç¾æœ‰ç©©å®šç‰ˆ) ---
        function fetchWeather(city) {
            const c = cityCoords[city];
            fetch(`https://api.open-meteo.com/v1/forecast?latitude=${c.lat}&longitude=${c.lon}&hourly=temperature_2m&timezone=Asia%2FTokyo&forecast_days=1`)
            .then(r => r.json()).then(data => {
                document.getElementById('weather-city').innerText = city;
                document.getElementById('hourly-weather').innerHTML = data.hourly.temperature_2m.slice(0, 24).filter((_, i) => i % 4 === 0).map((t, i) => `<div class="flex-1 text-center"><div class="text-[8px] mb-1 opacity-50">${i*4}:00</div><div class="text-[10px] font-bold serif">${Math.round(t)}Â°</div></div>`).join('');
            }).catch(() => {});
        }

        function renderShop() {
            const locs = ['All', ...new Set(shops.map(s => s.loc || 'æœªå®š'))];
            document.getElementById('shop-filter-bar').innerHTML = locs.map(l => `<button onclick="setFilter('${l}')" class="text-[9px] px-3 py-1 rounded-full border ${currentFilter === l ? 'bg-black text-white' : 'bg-white text-gray-400'}">${l}</button>`).join('');
            const filtered = currentFilter === 'All' ? shops : shops.filter(s => s.loc === currentFilter);
            document.getElementById('shopping-list').innerHTML = filtered.map(s => {
                let img = s.img || ''; if (img && !img.startsWith('data:')) img = 'data:image/jpeg;base64,' + img;
                return `<div class="bg-white p-4 rounded-3xl border shadow-sm flex flex-col gap-3 ${s.purchased ? 'purchased-item' : ''} text-sm">
                    <div class="flex gap-4">
                        <div class="w-14 h-14 bg-gray-50 rounded-2xl bg-cover bg-center flex-shrink-0" style="background-image:url('${img}')" onclick="viewImg('${img}')"></div>
                        <div class="flex-1">
                            <div class="flex justify-between font-bold"><span>${s.name}</span><button onclick="delShop(${s.id})">âœ•</button></div>
                            <div class="text-[9px] text-gray-400 mt-1">${s.spec || ''} | Qty: ${s.qty || 1}</div>
                            <div class="flex gap-2 mt-2 text-[8px] font-bold">
                                <span class="bg-indigo-50 text-indigo-400 px-2 py-0.5 rounded-full">${s.loc || 'æœªå®š'}</span>
                                <span class="bg-gray-100 text-gray-400 px-2 py-0.5 rounded-full">${s.purchaser || 'æœªæŒ‡å®š'}</span>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-between items-center border-t pt-3">
                        <input type="checkbox" ${s.purchased ? 'checked' : ''} onchange="toggleShop(${s.id})" class="accent-black">
                        <div class="text-xs">Â¥ <input type="number" value="${s.price || ''}" onblur="updateShopPrice(${s.id}, this.value)" class="w-20 border-b text-right outline-none bg-transparent"></div>
                    </div>
                </div>`;
            }).join('');
        }

        async function syncToSheets(type, data) { if (GAS_URL.includes("https")) { let s = JSON.parse(JSON.stringify(data)); if (s.img && s.img.length > 40000) s.img = "Too Large"; fetch(GAS_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ type, data: s }) }); } }
        function addShoppingItem() { const name = document.getElementById('shop-name').value; if (!name) return; const item = { id: Date.now(), name, spec: document.getElementById('shop-spec').value, qty: document.getElementById('shop-qty').value, loc: document.getElementById('shop-loc').value, purchaser: document.getElementById('shop-purchaser').value, img: tempImg, purchased: false, price: "" }; shops.unshift(item); localStorage.setItem('tr_shop_v10', JSON.stringify(shops)); renderShop(); syncToSheets("shop", item); document.getElementById('shop-name').value = ''; tempImg = null; }
        function toggleShop(id) { const i = shops.findIndex(s => s.id === id); shops[i].purcha