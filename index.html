<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 Kansai Journey</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #fcfaf7; --main: #2a2a2a; --blue: #1a2a6c; --gray: #71717a; }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: var(--bg); color: var(--main); line-height: 1.6; font-size: 16px; }
        .serif { font-family: 'Playfair Display', serif; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }

        /* æ™‚é–“è»¸ï¼šåŠ å¤§é–“è·èˆ‡å­—é«” */
        .timeline-item { position: relative; display: flex; padding-bottom: 2.5rem; cursor: pointer; }
        .time-side { width: 75px; flex-shrink: 0; text-align: right; padding-right: 20px; font-size: 1.4rem; font-weight: 700; position: relative; color: #111; }
        .time-side::after { content: ''; position: absolute; right: -1px; top: 14px; width: 10px; height: 10px; background: white; border: 1px solid #ccc; border-radius: 50%; z-index: 10; }
        .timeline-line { position: absolute; left: 74.5px; top: 14px; bottom: 0; width: 1px; background: #e5e7eb; }
        .content-side { flex: 1; padding-left: 20px; }

        /* å½ˆçª—ï¼šå¼·åŒ–å±¤æ¬¡æ„Ÿ */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(8px); }
        .modal-content { background: white; margin: 8vh auto; width: 92%; max-width: 450px; border-radius: 24px; position: relative; max-height: 82vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); animation: fadeInUp 0.4s ease; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }

        /* å°è¦½åˆ— */
        .nav-active { color: var(--blue) !important; font-weight: 700; }
        .day-btn.active { color: #111; font-weight: 700; border-bottom: 3px solid #111; }
        
        /* æ–‡å­—å¤§å°å¾®èª¿ */
        .text-header { font-size: 1.25rem; font-weight: 700; }
        .text-desc { font-size: 0.95rem; color: var(--gray); }
        .active-link { color: #2563eb; text-decoration: underline; word-break: break-all; font-weight: 500; }
    </style>
</head>
<body class="pb-24">

    <!-- Loading -->
    <div id="loading-overlay" class="fixed inset-0 bg-white z-[2000] flex items-center justify-center">
        <div class="text-center">
            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-indigo-900 mx-auto"></div>
            <p class="mt-4 text-xs text-gray-400 tracking-[0.3em] uppercase">Syncing Trip...</p>
        </div>
    </div>

    <header class="p-8 text-center">
        <div class="text-[10px] text-gray-400 tracking-[0.4em] mb-2 font-light uppercase">Osaka Trip Planner</div>
        <h1 class="text-2xl font-bold tracking-widest serif">å¤§é˜ª â— äº¬éƒ½ â— å…µåº«</h1>
    </header>

    <!-- è©³æƒ…å½ˆçª— -->
    <div id="infoModal" class="modal" onclick="closeModal()">
        <div class="modal-content p-8" onclick="event.stopPropagation()">
            <button class="absolute top-6 right-6 text-gray-400" onclick="closeModal()"><i class="fas fa-times text-2xl"></i></button>
            <div id="modal-body" class="space-y-6"></div>
        </div>
    </div>

    <!-- 1. è¡Œç¨‹ -->
    <div id="itinerary" class="tab-content active px-6">
        <div class="flex justify-between mb-10 overflow-x-auto hide-scrollbar space-x-8 px-2 text-gray-300">
            <button onclick="showDay(1)" class="day-btn pb-1 min-w-fit"><span class="text-[10px] block">MON</span><span class="text-xl serif">2/2</span></button>
            <button onclick="showDay(2)" class="day-btn pb-1 min-w-fit"><span class="text-[10px] block">TUE</span><span class="text-xl serif">2/3</span></button>
            <button onclick="showDay(3)" class="day-btn pb-1 min-w-fit"><span class="text-[10px] block">WED</span><span class="text-xl serif">2/4</span></button>
            <button onclick="showDay(4)" class="day-btn pb-1 min-w-fit"><span class="text-[10px] block">THU</span><span class="text-xl serif">2/5</span></button>
            <button onclick="showDay(5)" class="day-btn pb-1 min-w-fit"><span class="text-[10px] block">FRI</span><span class="text-xl serif">2/6</span></button>
        </div>

        <div id="day-content" class="relative"></div>
    </div>

    <!-- 2. ä»£è³¼ -->
    <div id="shopping" class="tab-content p-6">
        <div class="bg-white p-6 rounded-3xl border border-gray-100 mb-6">
            <h3 class="text-xs font-bold mb-4 text-gray-300 uppercase tracking-widest">Shopping Wish List</h3>
            <div class="space-y-4">
                <input type="text" id="shop-name" placeholder="å•†å“åç¨±" class="w-full border-b py-3 outline-none text-base">
                <div class="grid grid-cols-2 gap-4">
                    <input type="text" id="shop-spec" placeholder="è¦æ ¼" class="w-full border-b py-3 outline-none text-base">
                    <input type="number" id="shop-qty" placeholder="æ•¸é‡" class="w-full border-b py-3 outline-none text-base">
                </div>
                <input type="text" id="shop-loc" placeholder="ä»£è³¼å ´æ‰€" class="w-full border-b py-3 outline-none text-base">
                <input type="text" id="shop-purchaser" placeholder="è³¼è²·è€…" class="w-full border-b py-3 outline-none text-base">
                <button onclick="addShoppingItem()" class="w-full bg-black text-white py-4 rounded-full text-sm font-bold tracking-widest mt-4">ADD TO LIST</button>
            </div>
        </div>
        <div id="shopping-list" class="space-y-4"></div>
    </div>

    <!-- 3. è¨˜å¸³ -->
    <div id="ledger" class="tab-content p-6">
        <div class="bg-white p-6 rounded-3xl border border-gray-100 mb-6">
            <h3 class="text-xs font-bold mb-4 text-gray-300 uppercase tracking-widest text-center">Expense Ledger</h3>
            <div class="grid grid-cols-1 gap-4">
                <input type="text" id="exp-name" placeholder="æ¶ˆè²»é …ç›®" class="border-b py-3 outline-none text-base">
                <div class="grid grid-cols-2 gap-4">
                    <input type="number" id="exp-amount" placeholder="é‡‘é¡ Â¥" class="border-b py-3 outline-none text-base">
                    <select id="exp-method" class="border-b py-3 bg-transparent outline-none text-base"><option>ç¾é‡‘</option><option>åˆ·å¡</option><option>Suica</option></select>
                </div>
                <input type="date" id="exp-date" class="border-b py-3 outline-none text-base">
            </div>
            <button onclick="addExpense()" class="w-full bg-black text-white py-4 rounded-full text-sm font-bold mt-6 tracking-widest">SAVE CASH</button>
        </div>
        <div id="expense-list" class="space-y-2"></div>
        <div id="total-amount" class="mt-8 text-right font-light text-2xl">Total <span class="serif text-4xl font-bold ml-2">Â¥0</span></div>
    </div>

    <!-- 4. æ–‡ä»¶ -->
    <div id="tickets" class="tab-content p-6">
        <div class="bg-slate-900 text-white p-8 rounded-3xl mb-8 shadow-xl">
            <div class="text-[10px] opacity-40 tracking-[0.4em] mb-6 uppercase">Flight Summary</div>
            <div class="flex justify-between items-center mb-6">
                <div class="text-center"><div class="text-2xl font-bold serif">TPE</div><div class="text-xs opacity-50">09:20</div></div>
                <i class="fas fa-plane text-indigo-400 text-xl mx-4"></i>
                <div class="text-center"><div class="text-2xl font-bold serif">KIX</div><div class="text-xs opacity-50">12:50</div></div>
            </div>
            <p class="text-xs opacity-60 text-center tracking-widest">JX822 (2/2) / JX821 (2/6)</p>
        </div>
        <div id="doc-list" class="space-y-4"></div>
    </div>

    <!-- Nav -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-xl border-t border-gray-50 flex justify-around p-5 safe-area-bottom z-[1000]">
        <button onclick="switchTab('itinerary')" class="nav-btn flex flex-col items-center nav-active text-gray-300"><i class="fas fa-calendar-alt text-xl"></i><span class="text-[10px] mt-1">PLAN</span></button>
        <button onclick="switchTab('shopping')" class="nav-btn flex flex-col items-center text-gray-300"><i class="fas fa-shopping-cart text-xl"></i><span class="text-[10px] mt-1">SHOP</span></button>
        <button onclick="switchTab('ledger')" class="nav-btn flex flex-col items-center text-gray-300"><i class="fas fa-coins text-xl"></i><span class="text-[10px] mt-1">CASH</span></button>
        <button onclick="switchTab('tickets')" class="nav-btn flex flex-col items-center text-gray-300"><i class="fas fa-folder text-xl"></i><span class="text-[10px] mt-1">DOCS</span></button>
    </nav>

    <script>
        // --- æ ¸å¿ƒé…ç½® ---
        const GAS_URL = "https://script.google.com/macros/s/AKfycbzEv6Bda3jKfHZNoV-duexjmNT47igMmz0s_Ldm7fRyR23TH619rqp3bzYd9jXUT0yO/exec"; 

        // --- å®Œæ•´è¡Œç¨‹æ•¸æ“š (å¾ PDF æå–) ---
        const travelData = {
            1: { city: "Osaka", items: [
                { t: "06:30", d: "æ©Ÿå ´æ·é‹ (å°åŒ—è»Šç«™)", m: "è¨ˆç¨‹è»Š", map: "https://maps.app.goo.gl/MW7Zr3WvPaUYwd537", detail: { about: "æ©Ÿå ´æ·é‹æ™‚åˆ»è¡¨æŸ¥è©¢æ–¼ä¸‹æ–¹é€£çµã€‚", link: "https://www.tymetro.com.tw/tymetro-new/tw/_pages/travel-guide/timetable-search.php" }},
                { t: "07:10", d: "æ¡ƒåœ’æ©Ÿå ´ ç¬¬ä¸€èˆªå»ˆ", m: "æ©Ÿæ·", map: "https://maps.app.goo.gl/wEwQpbYUt7wF14Vf8", detail: { about: "æŠµé”å¾Œæ˜Ÿå®‡èˆªç©ºæ«ƒå°å ±åˆ°ã€‚å®Œæˆå¾Œå¯è‡³ç¬¬äºŒèˆªå»ˆå…¥é—œäº«ç”¨è²´è³“å®¤æ—©é¤ã€‚" }},
                { t: "09:20", d: "æ˜Ÿå®‡ JX822 èµ·é£›", m: "é£›æ©Ÿ", map: "https://maps.app.goo.gl/JLbrA5JiHkfwz835A", detail: { about: "é£›å¾€é—œè¥¿æ©Ÿå ´ (KIX)ã€‚", link: "https://www.howto-osaka.com/tc/access-timetable/" }},
                { t: "14:00", d: "ğŸ›ï¸ è‡¨ç©ºåŸ Outlet", m: "é›»éµ", map: "https://maps.app.goo.gl/ScyV1p9Va6UDRcrW8", detail: { 
                    about: "é—œè¥¿æœ€å¤§ç­‰ç´š OUTLETã€‚é£›æ©Ÿè½åœ°ç¬¬ä¸€æ³¢è¡€æ‹¼ã€‚é¢æµ·è¨­è¨ˆå¯çœ‹è·‘é“å¤•é™½ã€‚",
                    buy: "å¿…è²·ï¼šè¥¿æ¾å±‹ã€Onitsuka Tigerã€Nike/Adidasã€Colemanã€Crocsã€‚",
                    link: "https://www.premiumoutlets.co.jp/rinku/brands/pdf/rinku.pdf"
                }},
                { t: "19:25", d: "é›£æ³¢æ ¼åˆ©èŒ²é£¯åº—å…¥ä½", m: "å—æµ·", map: "https://maps.app.goo.gl/BYcsfakHzt5pYJwi9", detail: { about: "æ­ä¹˜å—æµ·ç‰¹æ€¥ Rapi:tï¼Œéœ€è‡³çª—å£è³¼ç¥¨ï¼Œä¸å¯ç›´æ¥åˆ·å¡ä¸Šè»Šã€‚" }},
                { t: "19:30", d: "ğŸ± æ™šé¤ï¼šå¤§èµ·æ°´ç”¢å£½å¸", m: "å¾’æ­¥", map: "https://maps.app.goo.gl/4ZijhBKwhh4oWKmt6", detail: { buy: "å¿…åƒï¼šé»‘é®ªé­šèµ¤èº«/ä¸­è…¹ã€ç‚™ç‡’é®­é­šè‚šã€èŒ¶ç¢—è’¸ã€‚" }}
            ]},
            2: { city: "Kyoto", items: [
                { t: "06:55", d: "èŸ¹é“æ¨‚æ±åº—é›†åˆ", m: "é›†åˆ", map: "https://maps.app.goo.gl/wGSZwfghYPAUpq727", detail: { about: "ææ—© 15 åˆ†é˜å‡ºé–€ã€‚è·¯ä¸Šå¯è²·æ—©é¤å¸¶ä¸Šè»Šã€‚" }},
                { t: "10:00", d: "ğŸš¢ ä¼Šæ ¹ç£éŠè¦½èˆ¹", m: "æ™¯é»", map: "https://maps.app.goo.gl/M1y4cYrxukxZw9AAA", detail: { about: "æ—¥æœ¬èˆŸå±‹ä»£è¡¨ã€‚å¯é¤µæµ·é·—ã€‚å†¬å­£æ·±è—æµ·è‰²å¾ˆæœ‰ç§˜å¢ƒæ„Ÿã€‚" }},
                { t: "11:00", d: "ğŸš  å¤©æ©‹ç«‹å‚˜æ¾å…¬åœ’", m: "çºœè»Š", map: "https://maps.app.goo.gl/Q2G1kdLTxYXpqwgE6", detail: { about: "æ—¥æœ¬ä¸‰æ™¯ã€‚é‡é»åœ¨ã€Œå€’é ­æ ½ã€è¦–è§’ã€‚", buy: "å¿…åƒï¼šæ™ºæƒ åœ˜å­ã€æŠ¹èŒ¶æ—¥å¼çµ„åˆã€‚" }},
                { t: "14:45", d: "ğŸ¡ ç¾å±±èŒ…è‰å±‹ä¹‹é‡Œ", m: "å·´å£«", map: "https://maps.app.goo.gl/TGn1n7bdZyGeb33a6", detail: { about: "åŸå§‹èŒ…è‰å±‹èšè½ã€‚å†¬å­£é›ªæ™¯çµ•ç¾ã€‚", buy: "æ¨è–¦ï¼šæ‰‹å·¥ç±³æœã€åœ¨åœ°å‘³å™Œã€ç¾å±±ç‰›ä¹³ç”œé»ã€‚" }},
                { t: "19:40", d: "æ¢…ç”°é¾ä»•æŸé£¯åº—å…¥ä½", m: "åœ°éµ", map: "https://maps.app.goo.gl/LSLKXtng8oKr4Q4QA", detail: { about: "é›£æ³¢ç«™æ­ä¹˜å¾¡å ‚ç­‹ç·šè‡³æ¢…ç”°ç«™ã€‚" }}
            ]},
            3: { city: "Kyoto", items: [
                { t: "14:40", d: "â›©ï¸ è²´èˆ¹ç¥ç¤¾åƒæ‹œ", m: "ç¥ç¤¾", map: "https://maps.app.goo.gl/2SeLPrBbPPCxQV1p9", detail: { about: "å¤¢å¹»çŸ³éšã€å¤œé–“é»ç‡ˆã€‚å¿…è©¦æ°´å åœã€‚", buy: "ç¥ˆæ±‚ï¼šå§»ç·£ã€è‰¯ç·£ã€äº‹æ¥­é‹ã€‚" }},
                { t: "20:30", d: "ğŸ¥© æ™šé¤ï¼šç‡’è‚‰åŠ›ä¸¸", m: "åƒåˆ°é£½", map: "https://maps.app.goo.gl/mSRk6AkBcJV6ta7A", detail: { buy: "å¿…åƒï¼šé¹½è”¥ç‰›èˆŒã€å’Œç‰›è‚©èƒ›ã€çƒ¤è’œç‰‡ç™½é£¯ã€‚" }}
            ]},
            4: { city: "Hyogo", items: [
                { t: "09:30", d: "ğŸ”´ å‹å°¾å¯º", m: "å‹é‹", map: "https://maps.app.goo.gl/au2qs1mkMEeMs66b8", detail: { about: "éåœ°é”æ‘©å£¯è§€ç¾æ™¯ã€‚", link: "https://www.asoview.com/item/ticket/ticket0000039224/" }},
                { t: "13:35", d: "ğŸ¯ å§¬è·¯åŸ", m: "ä¸–ç•Œéºç”¢", map: "https://maps.app.goo.gl/GeWsaaQig2eerPim9", detail: { about: "ç™½é·ºåŸã€‚æ—¥æœ¬ç¬¬ä¸€ååŸã€‚", buy: "åç‰©ï¼šç™½è‰²å¸ƒä¸ã€å§¬è·¯é—œæ±ç…®ã€‚" }}
            ]},
            5: { city: "Osaka", items: [
                { t: "08:00", d: "é£¯åº—å‡ºç™¼ (æ©Ÿå ´æ¥é€)", m: "KKDAY", map: "https://maps.app.goo.gl/LSLKXtng8oKr4Q4QA", detail: { about: "é ç´„ KKDAY æ¥é€ã€‚" }},
                { t: "12:20", d: "âœˆï¸ é—œè¥¿æ©Ÿå ´èµ·é£›", m: "æ˜Ÿå®‡", map: "https://maps.app.goo.gl/wEwQpbYUt7wF14Vf8", detail: { about: "æ­ä¹˜ JX821 è¿”å°ã€‚" }}
            ]}
        };

        // --- æ ¸å¿ƒ JS é‚è¼¯ ---
        let shops = JSON.parse(localStorage.getItem('tr_shop_v11')) || [];
        let exps = JSON.parse(localStorage.getItem('tr_exp_v11')) || [];
        let docs = JSON.parse(localStorage.getItem('tr_doc_v11')) || [];
        let currentDay = 1;

        async function initData() {
            try {
                // 1. ç«‹å³æ¸²æŸ“ (é˜²å¡æ­»)
                showDay(1); renderShop(); renderLedger(); renderDocs();
                document.getElementById('loading-overlay').classList.add('hidden');

                // 2. ç•°æ­¥æŠ“é›²ç«¯
                if (GAS_URL.startsWith("https")) {
                    const res = await fetch(GAS_URL, { signal: AbortSignal.timeout(5000) });
                    const cloud = await res.json();
                    if (cloud.shops) { shops = cloud.shops; localStorage.setItem('tr_shop_v11', JSON.stringify(shops)); renderShop(); }
                    if (cloud.exps) { exps = cloud.exps; localStorage.setItem('tr_exp_v11', JSON.stringify(exps)); renderLedger(); }
                }
            } catch (e) {
                document.getElementById('loading-overlay').classList.add('hidden');
                console.warn("Cloud Sync Fail");
            }
        }

        function showDay(day) {
            currentDay = day;
            const data = travelData[day];
            let html = '<div class="timeline-line"></div>';
            data.items.forEach((item, idx) => {
                html += `
                <div class="timeline-item" onclick="openDetail(${day}, ${idx})">
                    <div class="time-side serif">${item.t.split(':')[0]}<span class="text-[10px] text-gray-300">Â°</span></div>
                    <div class="content-side">
                        <div class="text-[10px] font-bold text-gray-300 tracking-tighter uppercase mb-1">${item.type || item.m}</div>
                        <h4 class="text-lg font-bold text-gray-800 leading-tight flex justify-between items-center">
                            ${item.d}
                            <i class="fas fa-location-arrow text-red-500 text-[12px] opacity-40"></i>
                        </h4>
                    </div>
                </div>`;
            });
            document.getElementById('day-content').innerHTML = html;
            document.querySelectorAll('.day-btn').forEach((b, i) => b.classList.toggle('active', i+1===day));
        }

        function openDetail(day, idx) {
            const item = travelData[day].items[idx];
            const detail = item.detail || {};
            let html = `
                <div class="flex items-center gap-2 mb-2"><span class="text-[10px] bg-black text-white px-3 py-1 font-bold uppercase">${item.m}</span><span class="text-sm serif">${item.t}</span></div>
                <h2 class="text-2xl font-bold serif leading-tight">${item.d}</h2>
            `;
            if (detail.about) html += `<div class="mt-4"><p class="text-base text-gray-600">${detail.about}</p></div>`;
            if (detail.buy) html += `<div class="mt-4 p-4 bg-orange-50 border-l-4 border-orange-200 rounded-r-xl"><h5 class="text-xs font-bold text-orange-600 tracking-widest mb-1 uppercase">Must Eat / Buy</h5><p class="text-base text-orange-900">${detail.buy}</p></div>`;
            if (detail.link) html += `<div class="mt-4"><h5 class="text-[10px] text-gray-400 uppercase mb-1">Related Links</h5><a href="${detail.link}" target="_blank" class="active-link text-sm">${detail.link}</a></div>`;
            html += `<button onclick="window.open('${item.map}')" class="w-full bg-black text-white py-5 rounded-2xl text-sm font-bold mt-8 tracking-widest uppercase">Open Google Maps</button>`;
            
            document.getElementById('modal-body').innerHTML = html;
            document.getElementById('infoModal').style.display = 'block';
        }

        function closeModal() { document.getElementById('infoModal').style.display = 'none'; }

        // --- è¨˜å¸³ã€ä»£è³¼é‚è¼¯ (ç©©å®šç‰ˆ) ---
        function renderShop() {
            document.getElementById('shopping-list').innerHTML = shops.map(s => `
                <div class="bg-white p-5 rounded-3xl border border-gray-100 flex flex-col gap-4 shadow-sm">
                    <div class="flex gap-4">
                        <div class="w-16 h-16 bg-gray-50 rounded-2xl bg-cover bg-center flex-shrink-0" style="background-image:url(${s.img || ''})"></div>
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between font-bold text-base"><span>${s.name}</span><button onclick="delShop(${s.id})" class="text-gray-200">âœ•</button></div>
                            <div class="text-sm text-gray-400 mt-1">${s.spec || ''} | Qty: ${s.qty || 1}</div>
                        </div>
                    </div>
                    <div class="flex justify-between items-center border-t border-gray-50 pt-3">
                        <span class="text-xs font-bold bg-indigo-50 text-indigo-400 px-3 py-1 rounded-full">${s.loc || 'æœªå®š'}</span>
                        <div class="text-base font-bold serif text-red-600">Â¥ ${s.price || '--'}</div>
                    </div>
                </div>`).join('');
        }

        function addShoppingItem() {
            const name = document.getElementById('shop-name').value;
            if(!name) return;
            const item = { id: Date.now(), name, spec: document.getElementById('shop-spec').value, qty: document.getElementById('shop-qty').value, loc: document.getElementById('shop-loc').value, purchaser: document.getElementById('shop-purchaser').value, purchased: false };
            shops.unshift(item); localStorage.setItem('tr_shop_v11', JSON.stringify(shops));
            renderShop(); syncToSheets("shop", item);
            document.getElementById('shop-name').value = '';
        }

        function delShop(id) { shops = shops.filter(s => s.id !== id); localStorage.setItem('tr_shop_v11', JSON.stringify(shops)); renderShop(); syncToSheets("del_shop", {id}); }

        function addExpense() {
            const e = { id: Date.now(), name: document.getElementById('exp-name').value, amt: document.getElementById('exp-amount').value, method: document.getElementById('exp-method').value, date: document.getElementById('exp-date').value };
            if(!e.name || !e.amt) return;
            exps.unshift(e); localStorage.setItem('tr_exp_v11', JSON.stringify(exps));
            renderLedger(); syncToSheets("exp", e);
            document.getElementById('exp-name').value = ''; document.getElementById('exp-amount').value = '';
        }

        function renderLedger() {
            let total = 0;
            document.getElementById('expense-list').innerHTML = exps.map(e => {
                total += Number(e.amt);
                return `<div class="bg-white p-4 border-b flex justify-between items-center"><div class="text-sm font-bold">${e.name}<div class="text-[10px] text-gray-300">${e.method} | ${e.date}</div></div><div class="flex gap-4 items-center font-bold text-base serif">Â¥${e.amt}<button onclick="delExp(${e.id})" class="text-gray-200">âœ•</button></div></div>`;
            }).join('');
            document.querySelector('#total-amount span').innerText = `Â¥${total}`;
        }
        function delExp(id) { exps = exps.filter(e => e.id !== id); localStorage.setItem('tr_exp_v11', JSON.stringify(exps)); renderLedger(); syncToSheets("del_exp", {id}); }

        function renderDocs() {
            document.getElementById('doc-list').innerHTML = docs.map(d => `<div class="bg-white p-4 rounded-2xl border flex justify-between items-center text-sm font-bold"><span>${d.name}</span><button onclick="viewImg('${d.img}')" class="text-blue-500">VIEW</button></div>`).join('');
        }

        async function syncToSheets(type, data) {
            if (!GAS_URL.startsWith("https")) return;
            fetch(GAS_URL, { method: "POST", mode: 'no-cors', body: JSON.stringify({ type, data }) });
        }

        function switchTab(t) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(t).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.add('text-gray-300'));
            event.currentTarget.classList.remove('text-gray-300');
        }

        function viewImg(s) { if(!s) return; const w = window.open(""); w.document.write(`<img src="${s}" style="width:100%">`); }

        window.onload = initData;
    </script>
</body>
</html>