<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 Kansai Premium Guide</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #fcfaf7; --main: #2a2a2a; --blue: #1a2a6c; --orange: #f97316; }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: var(--bg); color: var(--main); line-height: 1.6; font-size: 16px; }
        .serif { font-family: 'Playfair Display', serif; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }

        /* æ™‚é–“è»¸ */
        .timeline-item { position: relative; display: flex; padding-bottom: 2.8rem; cursor: pointer; }
        .time-side { width: 75px; flex-shrink: 0; text-align: right; padding-right: 20px; font-size: 1.4rem; font-weight: 700; position: relative; color: #111; }
        .time-side::after { content: ''; position: absolute; right: -1px; top: 14px; width: 10px; height: 10px; background: white; border: 1px solid #ccc; border-radius: 50%; z-index: 10; }
        .timeline-line { position: absolute; left: 74.5px; top: 14px; bottom: 0; width: 1px; background: #e5e7eb; }
        .content-side { flex: 1; padding-left: 20px; }

        /* å½ˆçª—ç´°ç¯€ */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(8px); }
        .modal-content { background: white; margin: 5vh auto; width: 92%; max-width: 450px; border-radius: 28px; position: relative; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px rgba(0,0,0,0.3); animation: fadeInUp 0.4s ease; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }

        .nav-active { color: var(--blue) !important; font-weight: 700; }
        .day-btn.active { color: #111; font-weight: 700; border-bottom: 3px solid #111; }
        .weather-hour { min-width: 60px; flex-shrink: 0; }
    </style>
</head>
<body class="pb-24">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white z-[3000] flex items-center justify-center">
        <div class="text-center">
            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-indigo-900 mx-auto"></div>
            <p class="mt-4 text-xs text-gray-400 tracking-[0.3em] uppercase">Loading Guide...</p>
        </div>
    </div>

    <header class="p-8 text-center">
        <div class="text-[10px] text-gray-400 tracking-[0.4em] mb-2 font-light uppercase">Premium Osaka Planner</div>
        <h1 class="text-2xl font-bold tracking-widest serif">å¤§é˜ª â— äº¬éƒ½ â— å…µåº«</h1>
    </header>

    <!-- Lightbox è©³æƒ… -->
    <div id="infoModal" class="modal" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <button class="absolute top-6 right-6 text-white bg-black/20 w-10 h-10 rounded-full z-10" onclick="closeModal()"><i class="fas fa-times"></i></button>
            <div id="modal-image" class="w-full h-56 bg-cover bg-center"></div>
            <div class="p-8 space-y-6" id="modal-body"></div>
        </div>
    </div>

    <!-- 1. PLAN è¡Œç¨‹ -->
    <div id="itinerary" class="tab-content active px-6">
        <div class="flex justify-between mb-8 overflow-x-auto hide-scrollbar space-x-6 px-2 text-gray-300">
            <button onclick="showDay(1)" class="day-btn pb-1 min-w-fit"><span class="text-[10px] block font-bold">MON</span><span class="text-xl serif">2/2</span></button>
            <button onclick="showDay(2)" class="day-btn pb-1 min-w-fit"><span class="text-[10px] block font-bold">TUE</span><span class="text-xl serif">2/3</span></button>
            <button onclick="showDay(3)" class="day-btn pb-1 min-w-fit"><span class="text-[10px] block font-bold">WED</span><span class="text-xl serif">2/4</span></button>
            <button onclick="showDay(4)" class="day-btn pb-1 min-w-fit"><span class="text-[10px] block font-bold">THU</span><span class="text-xl serif">2/5</span></button>
            <button onclick="showDay(5)" class="day-btn pb-1 min-w-fit"><span class="text-[10px] block font-bold">FRI</span><span class="text-xl serif">2/6</span></button>
        </div>

        <div id="weather-section" class="mb-10 p-5 bg-white border border-gray-100 rounded-2xl shadow-sm overflow-hidden">
            <h2 id="weather-city" class="text-[10px] font-bold tracking-widest uppercase mb-4 text-gray-400">Weather Hourly</h2>
            <div id="hourly-weather" class="flex space-x-2 overflow-x-auto hide-scrollbar text-center"></div>
        </div>

        <div id="day-content" class="relative"></div>
    </div>

    <!-- 2. SHOP ä»£è³¼ -->
    <div id="shopping" class="tab-content p-6">
        <div class="bg-white p-6 rounded-3xl border border-gray-100 mb-6">
            <h3 class="text-xs font-bold mb-4 text-gray-300 uppercase tracking-widest text-center">Add New Wish</h3>
            <div class="space-y-4">
                <input type="text" id="shop-name" placeholder="å•†å“åç¨±" class="w-full border-b py-3 outline-none text-base">
                <div class="grid grid-cols-2 gap-4">
                    <input type="text" id="shop-spec" placeholder="è¦æ ¼" class="w-full border-b py-3 outline-none text-base">
                    <input type="number" id="shop-qty" placeholder="æ•¸é‡" class="w-full border-b py-3 outline-none text-base">
                </div>
                <input type="text" id="shop-loc" placeholder="ä»£è³¼å ´æ‰€" class="w-full border-b py-3 outline-none text-base">
                <input type="text" id="shop-purchaser" placeholder="è³¼è²·è€…" class="w-full border-b py-3 outline-none text-base">
                <label class="block border border-dashed border-gray-200 py-4 text-center rounded-2xl text-gray-400 text-xs cursor-pointer">
                    <span id="shop-img-status"><i class="fas fa-camera mr-2"></i>ä¸Šå‚³å•†å“åœ–ç‰‡</span>
                    <input type="file" accept="image/*" class="hidden" onchange="processImage(this)">
                </label>
                <button onclick="addShoppingItem()" class="w-full bg-black text-white py-4 rounded-full text-sm font-bold tracking-widest">SAVE TO LIST</button>
            </div>
        </div>
        <div id="shopping-list" class="space-y-4"></div>
    </div>

    <!-- 3. CASH è¨˜å¸³ -->
    <div id="ledger" class="tab-content p-6">
        <div id="total-amount" class="mb-8 text-center">
            <p class="text-[10px] text-gray-400 tracking-widest uppercase"><i class="fas fa-wallet mr-1"></i> Total Expenses</p>
            <div class="text-5xl font-bold serif text-red-600 mt-1">Â¥<span>0</span></div>
        </div>
        <div class="bg-white p-6 rounded-3xl border border-gray-100 mb-6">
            <div class="grid grid-cols-1 gap-4">
                <input type="text" id="exp-name" placeholder="æ¶ˆè²»é …ç›®" class="border-b py-3 outline-none text-base">
                <div class="grid grid-cols-2 gap-4">
                    <input type="number" id="exp-amount" placeholder="é‡‘é¡ Â¥" class="border-b py-3 outline-none text-base font-bold">
                    <select id="exp-method" class="border-b py-3 bg-transparent outline-none text-sm"><option>ç¾é‡‘</option><option>åˆ·å¡</option><option>Suica</option></select>
                </div>
                <input type="date" id="exp-date" class="border-b py-3 outline-none text-sm">
            </div>
            <button onclick="addExpense()" class="w-full bg-black text-white py-4 rounded-full text-sm font-bold mt-6 tracking-widest uppercase">Add Expense</button>
        </div>
        <div id="expense-list" class="space-y-2"></div>
    </div>

    <!-- 4. DOCS æ–‡ä»¶ -->
    <div id="tickets" class="tab-content p-6">
        <div class="bg-slate-900 text-white p-8 rounded-3xl mb-8 shadow-xl">
            <h3 class="text-[10px] opacity-40 tracking-[0.4em] mb-6 uppercase">Flight Details</h3>
            <div class="flex justify-between items-center mb-6">
                <div class="text-center"><div class="text-2xl font-bold serif">TPE</div><div class="text-xs opacity-50">09:20 AM</div></div>
                <i class="fas fa-plane-departure text-indigo-400 text-2xl mx-4"></i>
                <div class="text-center"><div class="text-2xl font-bold serif">KIX</div><div class="text-xs opacity-50">12:50 PM</div></div>
            </div>
            <div class="text-xs opacity-60 space-y-2 border-t border-white/10 pt-4">
                <p>2/2 å»ç¨‹ï¼šæ˜Ÿå®‡ JX822 (A350-900)</p>
                <p>2/6 å›ç¨‹ï¼šæ˜Ÿå®‡ JX821 (12:20 PM - 02:35 PM)</p>
            </div>
        </div>

        <h3 class="text-xs font-bold mb-4 text-gray-400 uppercase tracking-widest ml-2">Hotel Navigations</h3>
        <div class="space-y-4 mb-8">
            <div class="bg-white p-5 rounded-2xl border flex justify-between items-center">
                <div><div class="text-sm font-bold">é›£æ³¢æ ¼åˆ©èŒ²é£¯åº—</div><div class="text-[10px] text-gray-400">2/2 - 2/3 (1æ™š)</div></div>
                <button onclick="navigate('GRIDS PREMIUM HOTEL OSAKA NAMBA')" class="text-blue-500 bg-blue-50 w-10 h-10 rounded-full"><i class="fas fa-map-marked-alt"></i></button>
            </div>
            <div class="bg-white p-5 rounded-2xl border flex justify-between items-center">
                <div><div class="text-sm font-bold">æ¢…ç”°é¾ä»•æŸé£¯åº—</div><div class="text-[10px] text-gray-400">2/3 - 2/6 (3æ™š)</div></div>
                <button onclick="navigate('Hotel Hankyu RESPIRE OSAKA')" class="text-blue-500 bg-blue-50 w-10 h-10 rounded-full"><i class="fas fa-map-marked-alt"></i></button>
            </div>
        </div>
        <div id="doc-list" class="space-y-3 mt-6"></div>
    </div>

    <!-- Nav -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-xl border-t border-gray-100 flex justify-around p-5 safe-area-bottom z-[1000]">
        <button onclick="switchTab('itinerary')" class="nav-btn flex flex-col items-center nav-active text-gray-300"><i class="fas fa-calendar-check text-xl"></i><span class="text-[9px] mt-1">PLAN</span></button>
        <button onclick="switchTab('shopping')" class="nav-btn flex flex-col items-center text-gray-300"><i class="fas fa-shopping-bag text-xl"></i><span class="text-[9px] mt-1">SHOP</span></button>
        <button onclick="switchTab('ledger')" class="nav-btn flex flex-col items-center text-gray-300"><i class="fas fa-wallet text-xl"></i><span class="text-[9px] mt-1">CASH</span></button>
        <button onclick="switchTab('tickets')" class="nav-btn flex flex-col items-center text-gray-300"><i class="fas fa-folder-open text-xl"></i><span class="text-[9px] mt-1">DOCS</span></button>
    </nav>

    <script>
        // --- è¨­å®š (å¡«å¯«ä½ çš„ GAS URL) ---
        const GAS_URL = "https://script.google.com/macros/s/AKfycbzEv6Bda3jKfHZNoV-duexjmNT47igMmz0s_Ldm7fRyR23TH619rqp3bzYd9jXUT0yO/exec"; 

        // --- å®Œæ•´è¡Œç¨‹æ•¸æ“šåº« (æ™¯é»è±å¯ŒåŒ–) ---
        const travelData = {
            1: { city: "Osaka", coords: {lat: 34.69, lon: 135.50}, items: [
                { t: "06:30", d: "æ©Ÿå ´æ·é‹ (å°åŒ—è»Šç«™)", m: "äº¤é€š", r: "æ­ä¹˜è¨ˆç¨‹è»Šå‰å¾€åŒ—è»Šè½‰ä¹˜æ©Ÿæ·ã€‚", img: "https://images.unsplash.com/photo-1590674899484-d5640e854abe?q=80&w=500&auto=format", detail: { about: "æ©Ÿå ´æ·é‹ç›´é”è»Šç´„36åˆ†é˜å¯æŠµé”ç¬¬ä¸€èˆªå»ˆã€‚" }},
                { t: "09:20", d: "æ˜Ÿå®‡èˆªç©º JX822 èµ·é£›", m: "å»ç¨‹", r: "å‰å¾€é—œè¥¿æ©Ÿå ´ (KIX)ã€‚", img: "https://images.unsplash.com/photo-1436491865332-7a61a109c0f3?q=80&w=500&auto=format", detail: { about: "æ˜Ÿå®‡ A350 å®¢æ©Ÿï¼Œå ±åˆ°å¾Œå¯è‡³è²´è³“å®¤äº«ç”¨æ—©é»ã€‚" }},
                { t: "14:00", d: "ğŸ›ï¸ è‡¨ç©ºåŸ Outlet", m: "è³¼ç‰©", r: "é—œè¥¿æœ€å¤§è¦æ¨¡ Outletã€‚", img: "https://www.premiumoutlets.co.jp/en/rinku/common/img/ogp.jpg", detail: { 
                    about: "ä½æ–¼æ©Ÿå ´å°å²¸ï¼Œå»ºç¯‰å……æ»¿ç¾åœ‹æŸ¥çˆ¾æ–¯é “æ¸¯å£é¢¨æ ¼ã€‚æ“æœ‰250é–“å“ç‰Œï¼Œæ˜¯é—œè¥¿è½åœ°å¾Œè¡€æ‹¼çš„é¦–é¸ã€‚",
                    buy: "å¿…é€›ï¼šOnitsuka Tiger (é™å®šè‰²)ã€è¥¿æ¾å±‹ (ç«¥è£)ã€Coleman (æˆ¶å¤–ç”¨å“)ã€‚"
                }},
                { t: "19:30", d: "ğŸ± æ™šé¤ï¼šå¤§èµ·æ°´ç”¢å£½å¸", m: "ç¾é£Ÿ", r: "é“é “å €äººæ°£å£½å¸åº—ã€‚", img: "https://lh3.googleusercontent.com/p/AF1QipN3X-Xk_q2_83x-k699PshjYfM-N6V8V8L0G-5U=s1360-w1360-h1020", detail: { about: "ä»¥æ–°é®®ç›´é€èåï¼Œåƒ¹æ ¼è¦ªæ°‘ã€‚é»‘é®ªé­šä¸­è…¹èˆ‡ç‚™ç‡’é®­é­šæ˜¯å¿…é»æ‹›ç‰Œã€‚" }},
                { t: "22:30", d: "ğŸœ æ¶ˆå¤œï¼šä¸€è˜­æ‹‰éºµ", m: "ç¾é£Ÿ", r: "é“é “å €åˆ¥é¤¨æˆ–å¾¡å ‚ç­‹åº—ã€‚", img: "https://images.unsplash.com/photo-1569718212165-3a8278d5f624?q=80&w=500&auto=format", detail: { about: "æ—¥æœ¬ä»£è¡¨æ€§æ‹‰éºµï¼Œå®¢è£½åŒ–çš„æ¹¯é ­èˆ‡ç§˜è£½ç´…è¾£ç²‰ã€‚" }}
            ]},
            2: { city: "Kyoto", coords: {lat: 35.55, lon: 135.19}, items: [
                { t: "10:00", d: "ğŸš¢ ä¼Šæ ¹ç£éŠè¦½èˆ¹", m: "æ™¯é»", r: "æ¬£è³ç¨ç‰¹çš„èˆŸå±‹å»ºç¯‰ã€‚", img: "https://images.unsplash.com/photo-1542931287-023b922fa89b?q=80&w=500&auto=format", detail: { about: "ä¼Šæ ¹èˆŸå±‹æ˜¯æ—¥æœ¬æœ€ç¾æ‘èŠä¹‹ä¸€ï¼Œå»ºç¯‰èˆ‡æµ·ç›¸é„°ã€‚éŠè¦½èˆ¹æä¾›é¤µæµ·é·—é«”é©—ï¼Œå¯å¾æµ·ä¸Šé£½è¦½æ‘è½ç¾æ™¯ã€‚" }},
                { t: "11:00", d: "ğŸš  å¤©æ©‹ç«‹å‚˜æ¾å…¬åœ’", m: "ä¸‰æ™¯", r: "æ­çºœè»Šçœ‹ã€Œå€’é ­æ ½ã€ã€‚", img: "https://images.unsplash.com/photo-1570191935694-8116262453c5?q=80&w=500&auto=format", detail: { about: "æ—¥æœ¬ä¸‰æ™¯ä¹‹ä¸€ã€‚å¾è·¨ä¸‹å¾€å¾Œçœ‹çš„å¥‡æ™¯ä½¿æ²™æ´²åƒé£›å‘å¤©ç©ºçš„é’é¾ã€‚", buy: "å¿…åƒï¼šæ™ºæƒ åœ˜å­ (ç¥ˆæ±‚æ™ºæ…§)ã€‚" }},
                { t: "14:45", d: "ğŸ¡ ç¾å±±èŒ…è‰å±‹ä¹‹é‡Œ", m: "æ™¯é»", r: "äº¬éƒ½ç‰ˆåˆæŒæ‘ã€‚", img: "https://images.unsplash.com/photo-1493976040374-85c8e12f0c0e?q=80&w=500&auto=format", detail: { about: "ä¿ç•™å®Œæ•´çš„æ±Ÿæˆ¶æ™‚ä»£è¾²æ‘æ™¯è§€ï¼Œå†¬å­£é›ªæ™¯å®›å¦‚ç«¥è©±ä¸–ç•Œã€‚", buy: "æ¨è–¦ï¼šç¾å±±ç‰›ä¹³è£½æˆçš„æ¿ƒåšç”œé»ã€åœ¨åœ°å‘³å™Œã€‚" }}
            ]},
            3: { city: "Kyoto", coords: {lat: 35.01, lon: 135.76}, items: [
                { t: "14:40", d: "â›©ï¸ è²´èˆ¹ç¥ç¤¾", m: "å¤¢å¹»", r: "æ°´ç¥ç¸½æœ¬å®®èˆ‡ç‡ˆç± çŸ³éšã€‚", img: "https://images.unsplash.com/photo-1583002677234-927702891395?q=80&w=500&auto=format", detail: { about: "æœ€å…·ä»£è¡¨æ€§çš„æ˜¯ç´…ç‡ˆç± åƒé“ï¼Œå†¬å­£å¤œé–“é»ç‡ˆæ°£æ°›çµ•ä½³ã€‚", buy: "é«”é©—ï¼šæ°´å åœ (å°‡ç±¤ç´™æ”¾å…¥æ°´ä¸­é¡¯å½±)ã€‚" }},
                { t: "20:30", d: "ğŸ¥© æ™šé¤ï¼šç‡’è‚‰åŠ›ä¸¸", m: "ç¾é£Ÿ", r: "å¤§é˜ªäººæ°£æ”¾é¡Œç‡’è‚‰ã€‚", img: "https://lh3.googleusercontent.com/p/AF1QipN9f3f4iG3O3k-UqP1n2h8_TfX_h9xY_k_I5hU=s1360-w1360-h1020", detail: { about: "CPå€¼æ¥µé«˜çš„ç‡’è‚‰åƒåˆ°é£½ï¼Œå·²é ç´„æ¢…ç”°æ±é€šåº—ã€‚", buy: "æ¨è–¦ï¼šé¹½è”¥ç‰›èˆŒã€å’Œç‰›è‚©èƒ›ã€çƒ¤è’œç‰‡ç™½é£¯ã€‚" }}
            ]},
            4: { city: "Hyogo", coords: {lat: 34.81, lon: 134.69}, items: [
                { t: "09:30", d: "ğŸ”´ å‹å°¾å¯º", m: "å¿…è¨ª", r: "ç¥ˆæ±‚å‹é‹çš„é”æ‘©å¯ºã€‚", img: "https://lh3.googleusercontent.com/p/AF1QipNXF-n3yG3v7L-UqP1_U8_O3_I_f_V_l_I_G_U=s1360-w1360-h1020", detail: { about: "éåœ°çš†æ˜¯ä¿¡çœ¾é‚„é¡˜çš„é”æ‘©ä¸å€’ç¿ï¼Œæ˜¯ç¥ˆæ±‚äº‹æ¥­èˆ‡å­¸æ¥­é †åˆ©çš„é¦–é¸ã€‚" }},
                { t: "13:35", d: "ğŸ¯ å§¬è·¯åŸ", m: "åœ‹å¯¶", r: "ä¸–ç•Œéºç”¢ã€Œç™½é·ºåŸã€ã€‚", img: "https://images.unsplash.com/photo-1528164344705-47542687990d?q=80&w=500&auto=format", detail: { about: "æ—¥æœ¬ç¾å­˜æœ€å®Œå¥½çš„åœ‹å¯¶ç´šåŸå ¡ï¼Œç´”ç™½æœ¨æ§‹é€ å¤–è§€æ¥µå…¶å„ªé›…ã€‚", buy: "åç‰©ï¼šå§¬è·¯åŸç™½è‰²å¸ƒä¸ã€å§¬è·¯é—œæ±ç…®ã€‚" }}
            ]},
            5: { city: "Osaka", coords: {lat: 34.69, lon: 135.50}, items: [
                { t: "08:00", d: "ğŸš æ©Ÿå ´æ¥é€", m: "è¿”ç¨‹", r: "å‰å¾€é—œè¥¿æ©Ÿå ´ã€‚", img: "https://images.unsplash.com/photo-1569154941061-e231b4725ef1?q=80&w=500&auto=format", detail: { about: "ææ—© 3 å°æ™‚æŠµé”æ©Ÿå ´ï¼Œå¯åšæœ€å¾Œçš„å…ç¨…æ¡è²·ã€‚" }}
            ]}
        };

        // --- å…¨åŸŸç‹€æ…‹ ---
        let shops = JSON.parse(localStorage.getItem('tr_shop_v12')) || [];
        let exps = JSON.parse(localStorage.getItem('tr_exp_v12')) || [];
        let docs = JSON.parse(localStorage.getItem('tr_doc_v12')) || [];
        let tempImg = null;

        // --- åˆå§‹åŒ–é‚è¼¯ (ä¿®æ­£åŒæ­¥) ---
        async function initData() {
            renderShop(); renderLedger(); renderDocs(); showDay(1);
            document.getElementById('loading-overlay').classList.add('hidden');
            
            if (GAS_URL.startsWith("https")) {
                try {
                    const res = await fetch(GAS_URL, { signal: AbortSignal.timeout(6000) });
                    const cloud = await res.json();
                    if (cloud.shops) { shops = cloud.shops; localStorage.setItem('tr_shop_v12', JSON.stringify(shops)); renderShop(); }
                    if (cloud.exps) { exps = cloud.exps; localStorage.setItem('tr_exp_v12', JSON.stringify(exps)); renderLedger(); }
                } catch (e) { console.warn("Cloud Sync Timeout"); }
            }
        }

        // --- æ¯å°æ™‚æ°£è±¡ ---
        async function fetchWeather(day) {
            try {
                const c = travelData[day].coords;
                const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${c.lat}&longitude=${c.lon}&hourly=temperature_2m,weathercode&timezone=Asia%2FTokyo&forecast_days=1`);
                const data = await res.json();
                document.getElementById('weather-city').innerText = travelData[day].city + " 24H æ¯å°æ™‚é å ±";
                document.getElementById('hourly-weather').innerHTML = data.hourly.temperature_2m.slice(0, 24).map((t, i) => `
                    <div class="weather-hour">
                        <div class="text-[8px] text-gray-400 mb-1">${String(i).padStart(2, '0')}:00</div>
                        <div class="text-base mb-1">${data.hourly.weathercode[i] <= 3 ? 'â˜€ï¸' : 'â˜ï¸'}</div>
                        <div class="text-xs font-bold serif">${Math.round(t)}Â°</div>
                    </div>`).join('');
            } catch (e) {}
        }

        // --- è¡Œç¨‹æ¸²æŸ“ ---
        function showDay(day) {
            const data = travelData[day];
            fetchWeather(day);
            let html = '<div class="timeline-line"></div>';
            data.items.forEach((item, idx) => {
                html += `
                <div class="timeline-item" onclick="openDetail(${day}, ${idx})">
                    <div class="time-side serif">${item.t.split(':')[0]}<span class="text-[10px] text-gray-200">Â°</span></div>
                    <div class="content-side">
                        <div class="text-[10px] font-bold text-gray-300 tracking-tighter uppercase mb-1">${item.m}</div>
                        <h4 class="text-lg font-bold text-gray-800 leading-tight flex justify-between items-center">${item.d} <i class="fas fa-arrow-right text-[10px] opacity-10"></i></h4>
                        <p class="text-sm text-gray-400 mt-1 truncate">${item.r || ''}</p>
                    </div>
                </div>`;
            });
            document.getElementById('day-content').innerHTML = html;
            document.querySelectorAll('.day-btn').forEach((b, i) => b.classList.toggle('active', i+1===day));
        }

        function openDetail(day, idx) {
            const item = travelData[day].items[idx];
            const detail = item.detail || {};
            document.getElementById('modal-image').style.backgroundImage = `url('${item.img || ''}')`;
            document.getElementById('modal-body').innerHTML = `
                <div>
                    <div class="flex items-center gap-2 mb-2"><span class="text-[10px] bg-black text-white px-2 py-1 font-bold uppercase">${item.m}</span><span class="text-sm serif font-bold text-gray-300">${item.t}</span></div>
                    <h2 class="text-2xl font-bold serif leading-tight">${item.d}</h2>
                </div>
                <div class="text-base text-gray-600 leading-relaxed">${detail.about || ''}</div>
                ${detail.buy ? `<div class="p-5 bg-orange-50 border-l-4 border-orange-300 rounded-r-2xl"><h5 class="text-[10px] font-bold text-orange-600 tracking-widest uppercase mb-2">Must Eat / Buy</h5><p class="text-base text-orange-900 font-medium">${detail.buy}</p></div>` : ''}
                <button onclick="window.open('https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.d)}')" class="w-full bg-black text-white py-5 rounded-2xl text-sm font-bold tracking-widest uppercase"><i class="fas fa-location-arrow mr-2"></i>Map Guide</button>
            `;
            document.getElementById('infoModal').style.display = 'block';
        }

        // --- ä»£è³¼æ¸…å–® ---
        function renderShop() {
            document.getElementById('shopping-list').innerHTML = shops.map(s => {
                let img = s.img || ''; if (img && !img.startsWith('data:')) img = 'data:image/jpeg;base64,' + img;
                return `<div class="bg-white p-5 rounded-3xl border flex flex-col gap-4 shadow-sm">
                    <div class="flex gap-4">
                        <div class="w-16 h-16 bg-gray-50 rounded-2xl bg-cover bg-center flex-shrink-0" style="background-image:url('${img}')" onclick="viewImg('${img}')"></div>
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between font-bold text-base"><span>${s.name}</span><button onclick="delShop(${s.id})">âœ•</button></div>
                            <div class="text-xs text-gray-400 mt-1">${s.spec || ''} | Qty: ${s.qty || 1}</div>
                            <div class="flex gap-2 mt-2 font-bold"><span class="text-[10px] bg-indigo-50 text-indigo-400 px-2 py-1 rounded-full">${s.loc || 'æœªå®š'}</span><span class="text-[10px] bg-gray-50 text-gray-400 px-2 py-1 rounded-full">${s.purchaser || 'æˆ‘'}</span></div>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        function addShoppingItem() {
            const n = document.getElementById('shop-name').value; if(!n) return;
            const item = { id: Date.now(), name: n, spec: document.getElementById('shop-spec').value, qty: document.getElementById('shop-qty').value, loc: document.getElementById('shop-loc').value, purchaser: document.getElementById('shop-purchaser').value, img: tempImg };
            shops.unshift(item); localStorage.setItem('tr_shop_v12', JSON.stringify(shops));
            renderShop(); syncToSheets("shop", item);
            document.getElementById('shop-name').value = ''; tempImg = null;
            document.getElementById('shop-img-status').innerText = "ä¸Šå‚³å•†å“åœ–ç‰‡";
        }

        // --- è¨˜å¸³ ---
        function addExpense() {
            const n = document.getElementById('exp-name').value; const a = document.getElementById('exp-amount').value;
            if(!n || !a) return;
            const e = { id: Date.now(), name: n, amt: a, method: document.getElementById('exp-method').value, date: document.getElementById('exp-date').value };
            exps.unshift(e); localStorage.setItem('tr_exp_v12', JSON.stringify(exps));
            renderLedger(); syncToSheets("exp", e);
            document.getElementById('exp-name').value = ''; document.getElementById('exp-amount').value = '';
        }

        function renderLedger() {
            let total = 0;
            document.getElementById('expense-list').innerHTML = exps.map(e => {
                total += Number(e.amt);
                return `<div class="bg-white p-4 border-b flex justify-between items-center text-sm"><div><div class="font-bold">${e.name}</div><div class="text-[10px] text-gray-300">${e.method} | ${e.date}</div></div><div class="flex gap-4 items-center font-bold text-lg serif text-red-600">Â¥${e.amt}<button onclick="delExp(${e.id})" class="text-gray-200">âœ•</button></div></div>`;
            }).join('');
            document.querySelector('#total-amount span').innerText = total;
        }

        // --- åœ–ç‰‡è™•ç† ---
        function processImage(input) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = 400; canvas.height = (img.height/img.width)*400;
                    canvas.getContext('2d').drawImage(img, 0, 0, 400, canvas.height);
                    tempImg = canvas.toDataURL('image/jpeg', 0.4);
                    document.getElementById('shop-img-status').innerText = "âœ… åœ–ç‰‡å·²é¸å–";
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(input.files[0]);
        }

        // --- è¼”åŠ©å‡½æ•¸ ---
        function switchTab(t) { document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active')); document.getElementById(t).classList.add('active'); document.querySelectorAll('.nav-btn').forEach(b => b.classList.add('text-gray-300')); event.currentTarget.classList.remove('text-gray-300'); }
        function closeModal() { document.getElementById('infoModal').style.display = 'none'; }
        function navigate(l) { window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(l)}`, '_blank'); }
        function delShop(id) { shops = shops.filter(s => s.id !== id); localStorage.setItem('tr_shop_v12', JSON.stringify(shops)); renderShop(); }
        function delExp(id) { exps = exps.filter(e => e.id !== id); localStorage.setItem('tr_exp_v12', JSON.stringify(exps)); renderLedger(); }
        function viewImg(s) { if(!s) return; const w = window.open(""); w.document.write(`<body style="margin:0;background:#000;display:flex;align-items:center;justify-content:center;"><img src="${s}" style="max-width:100%;height:auto;"></body>`); }
        async function syncToSheets(type, data) { if (GAS_URL.startsWith("https")) { fetch(GAS_URL, { method: "POST", mode: 'no-cors', body: JSON.stringify({ type, data }) }); } }
        
        window.onload = initData;
    </script>
</body>
</html>